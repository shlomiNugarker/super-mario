var dt=Object.defineProperty;var ht=(n,e,t)=>e in n?dt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>ht(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();class ut{constructor(e=1/60,t=.5){a(this,"updateProxy");a(this,"update");a(this,"animationFrameId",null);a(this,"running",!1);a(this,"fps",0);a(this,"frameCount",0);a(this,"fpsTimestamp",0);a(this,"maxDeltaTime");let i=0,s=null;this.maxDeltaTime=t,this.updateProxy=r=>{if(s){const o=(r-s)/1e3;for(this.frameCount++,r-this.fpsTimestamp>=1e3&&(this.fps=this.frameCount*1e3/(r-this.fpsTimestamp),this.frameCount=0,this.fpsTimestamp=r),i+=Math.min(o,this.maxDeltaTime);i>e;)this.update(e),i-=e}else this.fpsTimestamp=r;s=r,this.running&&this.enqueue()}}enqueue(){this.animationFrameId=requestAnimationFrame(this.updateProxy)}start(){return this.running||(this.running=!0,this.enqueue()),this}stop(){return this.running&&this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.running=!1,this.animationFrameId=null),this}toggle(){return this.running?this.stop():this.start(),this}getFPS(){return Math.round(this.fps)}isRunning(){return this.running}}class ft{constructor(){a(this,"grid");this.grid=[]}forEach(e){this.grid.forEach((t,i)=>{t.forEach((s,r)=>{e(s,i,r)})})}delete(e,t){const i=this.grid[e];i&&delete i[t]}get(e,t){const i=this.grid[e];if(i)return i[t]}set(e,t,i){this.grid[e]||(this.grid[e]=[]),this.grid[e][t]=i}has(e,t){const i=this.grid[e];return i!==void 0&&i[t]!==void 0}get width(){return this.grid.length}get height(){let e=0;return this.grid.forEach(t=>{const i=t.length;i>e&&(e=i)}),e}}class f{constructor(e,t){a(this,"x");a(this,"y");this.set(e,t)}copy(e){return this.x=e.x,this.y=e.y,this}equals(e){return this.x===e.x&&this.y===e.y}distance(e){const t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)}set(e,t){return this.x=e,this.y=t,this}add(e){return this.x+=e.x,this.y+=e.y,this}subtract(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return this.x*=e,this.y*=e,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const e=this.length();return e>0&&(this.x/=e,this.y/=e),this}clone(){return new f(this.x,this.y)}}function pt(n,e,t){return n>t?t:n<e?e:n}const le=Object.freeze({UP:Object.freeze(new f(0,-1)),DOWN:Object.freeze(new f(0,1)),RIGHT:Object.freeze(new f(1,0)),LEFT:Object.freeze(new f(-1,0))});class Ze{constructor(){a(this,"buffers");a(this,"activeSources");a(this,"masterVolume",null);this.buffers=new Map,this.activeSources=new Map}addAudio(e,t){this.buffers.set(e,t)}init(e){this.masterVolume||(this.masterVolume=e.createGain(),this.masterVolume.connect(e.destination),this.masterVolume.gain.value=1)}setMasterVolume(e,t){if(this.masterVolume||this.init(e),this.masterVolume){const i=Math.max(0,Math.min(1,t));this.masterVolume.gain.value=i}}getMasterVolume(){var e;return((e=this.masterVolume)==null?void 0:e.gain.value)??1}playAudio(e,t,i={}){const s=this.buffers.get(e);if(!s)return console.warn(`Audio buffer not found: ${e}`),null;this.masterVolume||this.init(t);const r=t.createBufferSource();r.buffer=s,r.loop=i.loop??!1,i.rate!==void 0&&(r.playbackRate.value=i.rate);const o=t.createGain();o.gain.value=i.volume??1,r.connect(o),o.connect(i.destination??this.masterVolume??t.destination);const l=i.startTime??0;return r.start(l),this.activeSources.has(e)||this.activeSources.set(e,[]),this.activeSources.get(e).push(r),r.onended=()=>{const c=this.activeSources.get(e);if(c){const d=c.indexOf(r);d!==-1&&c.splice(d,1),c.length===0&&this.activeSources.delete(e)}},r}stopAudio(e){const t=this.activeSources.get(e);t&&(t.forEach(i=>{i.stop()}),this.activeSources.delete(e))}stopAll(){this.activeSources.forEach(e=>{e.forEach(t=>{t.stop()})}),this.activeSources.clear()}isPlaying(e){const t=this.activeSources.get(e);return t!==void 0&&t.length>0}hasAudio(e){return this.buffers.has(e)}getAudioNames(){return Array.from(this.buffers.keys())}}class $e{constructor(e,t,i){a(this,"pos");a(this,"size");a(this,"offset");this.pos=e,this.size=t,this.offset=i}overlaps(e){return this.bottom>e.top&&this.top<e.bottom&&this.left<e.right&&this.right>e.left}containsPoint(e,t){return e>=this.left&&e<=this.right&&t>=this.top&&t<=this.bottom}getCenter(){return new f(this.meridian,this.equator)}setCenter(e){this.meridian=e.x,this.equator=e.y}get width(){return this.size.x}get height(){return this.size.y}get area(){return this.width*this.height}get meridian(){return this.pos.x+this.offset.x+this.size.x/2}set meridian(e){this.pos.x=e-(this.size.x/2+this.offset.x)}get equator(){return this.pos.y+this.offset.y+this.size.y/2}set equator(e){this.pos.y=e-(this.size.y/2+this.offset.y)}get bottom(){return this.pos.y+this.size.y+this.offset.y}set bottom(e){this.pos.y=e-(this.size.y+this.offset.y)}get top(){return this.pos.y+this.offset.y}set top(e){this.pos.y=e-this.offset.y}get left(){return this.pos.x+this.offset.x}set left(e){this.pos.x=e-this.offset.x}get right(){return this.pos.x+this.size.x+this.offset.x}set right(e){this.pos.x=e-(this.size.x+this.offset.x)}contains(e){return e.left>=this.left&&e.right<=this.right&&e.top>=this.top&&e.bottom<=this.bottom}clone(){return new $e(this.pos.clone(),this.size.clone(),this.offset.clone())}setSize(e,t){this.size.set(e,t)}setOffset(e,t){this.offset.set(e,t)}}class mt{constructor(e=!1){a(this,"events");a(this,"listeners");a(this,"timestampEvents");this.events=[],this.listeners=new Map,this.timestampEvents=e}emit(e,...t){const i={name:e,args:t,...this.timestampEvents&&{timestamp:performance.now()}};this.events.push(i);const s=this.listeners.get(e);if(s)for(const r of s)r(...t)}process(e,t){for(const i of this.events)i.name===e&&t(...i.args)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){const i=this.listeners.get(e);if(!i)return!1;const s=i.indexOf(t);return s!==-1?(i.splice(s,1),!0):!1}has(e){return this.events.some(t=>t.name===e)}count(e){return this.events.filter(t=>t.name===e).length}clear(){this.events.length=0}clearByName(e){const t=this.events.length;return this.events=this.events.filter(i=>i.name!==e),t-this.events.length}getAllEvents(){return[...this.events]}}const Te=class Te{constructor(){a(this,"listeners");this.listeners=[]}listen(e,t,i=1/0){const s={name:e,callback:t,count:i};this.listeners.push(s)}finalize(e){this.listeners=this.listeners.filter(t=>(e.events.process(t.name,t.callback),--t.count))}queue(e){this.listen(Te.EVENT_TASK,e,1)}collides(e,t){}obstruct(e,t,i){}update(e,t,i){}};a(Te,"EVENT_TASK",Symbol("task"));let m=Te;const g={TOP:Symbol("top"),BOTTOM:Symbol("bottom"),LEFT:Symbol("left"),RIGHT:Symbol("right")},ae={center(n,e){e.bounds.setCenter(n.bounds.getCenter())},bottom(n,e){e.bounds.bottom=n.bounds.bottom},top(n,e){e.bounds.top=n.bounds.top},left(n,e){e.bounds.left=n.bounds.left},right(n,e){e.bounds.right=n.bounds.right}};class T{constructor(){a(this,"id");a(this,"audio");a(this,"events");a(this,"sounds");a(this,"pos");a(this,"vel");a(this,"size");a(this,"offset");a(this,"bounds");a(this,"lifetime");a(this,"traits");this.id=null,this.audio=new Ze,this.events=new mt,this.sounds=new Set,this.pos=new f(0,0),this.vel=new f(0,0),this.size=new f(0,0),this.offset=new f(0,0),this.bounds=new $e(this.pos,this.size,this.offset),this.lifetime=0,this.traits=new Map}addTrait(e){this.traits.set(e.constructor,e)}getTrait(e){return this.traits.get(e)}getGoTrait(){return Array.from(this.traits.values()).find(e=>"acceleration"in e&&"dragFactor"in e)}getJumpTrait(){return Array.from(this.traits.values()).find(e=>"velocity"in e&&"falling"in e&&"start"in e)}getKillableTrait(){return Array.from(this.traits.values()).find(e=>"dead"in e&&"kill"in e)}getPhysicsTrait(){return Array.from(this.traits.values()).find(e=>"enabled"in e&&e.constructor.name==="Physics")}getSolidTrait(){return Array.from(this.traits.values()).find(e=>"enabled"in e&&e.constructor.name==="Solid")}getPipeTravellerTrait(){return Array.from(this.traits.values()).find(e=>"movement"in e&&"distance"in e)}getPoleTravellerTrait(){return Array.from(this.traits.values()).find(e=>"distance"in e&&e.constructor.name==="PoleTraveller")}getStomperTrait(){return Array.from(this.traits.values()).find(e=>"bounceSpeed"in e)}getPendulumMoveTrait(){return Array.from(this.traits.values()).find(e=>"speed"in e&&e.constructor.name==="PendulumMove")}collides(e){this.traits.forEach(t=>{t.collides(this,e)})}obstruct(e,t){this.traits.forEach(i=>{i.obstruct(this,e,t)})}finalize(){this.events.emit(m.EVENT_TASK,this),this.traits.forEach(e=>{e.finalize(this)}),this.events.clear()}playSounds(e,t){this.sounds.forEach(i=>{e.playAudio(i,t)}),this.sounds.clear()}update(e,t){this.traits.forEach(i=>{i.update(this,e,t)}),this.playSounds(this.audio,e.audioContext),this.lifetime+=e.deltaTime}draw(e){}}const qe=Symbol("level timer earmark"),Z=class Z extends m{constructor(){super();a(this,"totalTime");a(this,"currentTime");a(this,"hurryTime");a(this,"hurryEmitted");this.totalTime=400,this.currentTime=this.totalTime,this.hurryTime=100,this.hurryEmitted=null}reset(){this.currentTime=this.totalTime}update(t,{deltaTime:i},s){this.currentTime-=i*2.5,s[qe]||(this.hurryEmitted=null),this.hurryEmitted!==!0&&this.currentTime<this.hurryTime&&(s.events.emit(Z.EVENT_TIMER_HURRY),this.hurryEmitted=!0),this.hurryEmitted!==!1&&this.currentTime>this.hurryTime&&(s.events.emit(Z.EVENT_TIMER_OK),this.hurryEmitted=!1),s[qe]=!0}};a(Z,"EVENT_TIMER_HURRY",Symbol("timer hurry")),a(Z,"EVENT_TIMER_OK",Symbol("timer ok"));let I=Z;class yt extends m{constructor(){super();a(this,"touches");a(this,"conditions");this.touches=new Set,this.conditions=[]}collides(t,i){this.touches.add(i)}update(t,i,s){if(this.touches.size>0){for(const r of this.conditions)r(t,this.touches,i,s);this.touches.clear()}}}const S=256,M=240,gt=1500,vt=175,b={musicEnabled:!0,soundEnabled:!0,debugEnabled:!1},v={sprites:"/sprites",audio:"/audio",levels:"/levels"};class bt{constructor(){a(this,"pos");a(this,"size");a(this,"min");a(this,"max");this.pos=new f(0,0),this.size=new f(S,M),this.min=new f(0,0),this.max=new f(1/0,1/0)}}class wt{constructor(){a(this,"player");this.player=null}setPlayer(e){this.player=e}playTheme(e=1){if(!this.player)return;const t=this.player.playTrack("main");t.playbackRate=e}playHurryTheme(){if(!this.player)return;const e=this.player.playTrack("hurry");e.loop=!1,e.addEventListener("ended",()=>{this.playTheme(1.3)},{once:!0})}pause(){this.player&&this.player.pauseAll()}}class xt{constructor(e){a(this,"entities");this.entities=e}check(e){this.entities.forEach(t=>{e!==t&&e.bounds.overlaps(t.bounds)&&e.collides(t)})}}class St{constructor(){a(this,"layers");this.layers=[]}draw(e,t){this.layers.forEach(i=>{i(e,t)})}}class Et{constructor(){a(this,"listeners");this.listeners=[]}listen(e,t){const i={name:e,callback:t,count:1/0};this.listeners.push(i)}emit(e,...t){this.listeners.forEach(i=>{i.name===e&&i.callback(...t)})}process(e,t){t()}}const pe=class pe{constructor(){a(this,"events");a(this,"comp");this.events=new Et,this.comp=new St}draw(e){e.videoContext&&e.camera&&this.comp.draw(e.videoContext,e.camera)}update(e){}pause(){console.log("Pause",this)}onComplete(e){this.events.listen(pe.EVENT_COMPLETE,e)}complete(){this.events.emit(pe.EVENT_COMPLETE)}};a(pe,"EVENT_COMPLETE","scene complete");let ee=pe;class et{constructor(e,t=16){a(this,"matrix");a(this,"tileSize");this.matrix=e,this.tileSize=t}toIndex(e){return Math.floor(e/this.tileSize)}toIndexRange(e,t){const i=Math.ceil(t/this.tileSize)*this.tileSize,s=[];let r=e;do s.push(this.toIndex(r)),r+=this.tileSize;while(r<i);return s}getByIndex(e,t){const i=this.matrix.get(e,t);if(i){const s=e*this.tileSize,r=s+this.tileSize,o=t*this.tileSize,l=o+this.tileSize;return{tile:i,indexX:e,indexY:t,x1:s,x2:r,y1:o,y2:l}}}searchByPosition(e,t){return this.getByIndex(this.toIndex(e),this.toIndex(t))}searchByRange(e,t,i,s){const r=[];return this.toIndexRange(e,t).forEach(o=>{this.toIndexRange(i,s).forEach(l=>{const c=this.getByIndex(o,l);c&&r.push(c)})}),r}}class w extends m{constructor(){super();a(this,"dead");a(this,"deadTime");a(this,"removeAfter");this.dead=!1,this.deadTime=0,this.removeAfter=2}kill(){this.queue(()=>this.dead=!0)}revive(){this.dead=!1,this.deadTime=0}update(t,{deltaTime:i},s){this.dead&&(this.deadTime+=i,this.deadTime>this.removeAfter&&this.queue(()=>{s.entities.delete(t)}))}}const ke=class ke extends m{constructor(){super();a(this,"bounceSpeed");this.bounceSpeed=400}bounce(t,i){t.bounds.bottom=i.bounds.top,t.vel.y=-this.bounceSpeed}collides(t,i){const s=i.traits.get(w);!s||s.dead||t.vel.y>i.vel.y&&(this.queue(()=>this.bounce(t,i)),t.sounds.add("stomp"),t.events.emit(ke.EVENT_STOMP,t,i))}};a(ke,"EVENT_STOMP",Symbol("stomp"));let J=ke;const Ke=100;class V extends m{constructor(){super();a(this,"name");a(this,"world");a(this,"coins");a(this,"lives");a(this,"score");this.name="UNNAMED",this.world="UNKNOWN",this.coins=0,this.lives=3,this.score=0,this.listen(J.EVENT_STOMP,()=>{this.score+=100,console.log("Score",this.score)})}addCoins(t){for(this.coins+=t,this.queue(i=>i.sounds.add("coin"));this.coins>=Ke;)this.addLives(1),this.coins-=Ke}addLives(t){this.lives+=t}}function Tt(n,e){n.pos.x=e.x-n.size.x/2,n.pos.y=e.y-n.size.y/2}function kt(n){return new f(n.x1+(n.x2-n.x1)/2,n.y1+(n.y2-n.y1)/2)}function Ct(n,e,t){const i=kt(t),s=[];for(let o=0;o<4;o++){const l=e.entityFactory.brickShrapnel();Tt(l,i),n.entities.add(l),s.push(l)}const r=60;s[0].sounds.add("break"),s[0].vel.set(-60,-400*1.2),s[1].vel.set(-60,-400),s[2].vel.set(r,-400*1.2),s[3].vel.set(r,-400)}function Mt({entity:n,match:e}){n.vel.x>0?n.bounds.right>e.x1&&n.obstruct(g.RIGHT,e):n.vel.x<0&&n.bounds.left<e.x2&&n.obstruct(g.LEFT,e)}function Pt({entity:n,match:e,resolver:t,gameContext:i,level:s}){n.vel.y>0?n.bounds.bottom>e.y1&&n.obstruct(g.BOTTOM,e):n.vel.y<0&&(n.traits.has(V)&&(t.matrix.delete(e.indexX,e.indexY),Ct(s,i,e)),n.bounds.top<e.y2&&n.obstruct(g.TOP,e))}const At=[Mt,Pt];function Ue({entity:n,match:e,resolver:t}){const i=n.traits.get(V);i&&(i.addCoins(1),t.matrix.delete(e.indexX,e.indexY))}const It=[Ue,Ue];function Lt({entity:n,match:e}){n.vel.x>0?n.bounds.right>e.x1&&n.obstruct(g.RIGHT,e):n.vel.x<0&&n.bounds.left<e.x2&&n.obstruct(g.LEFT,e)}function Dt({entity:n,match:e}){n.vel.y>0?n.bounds.bottom>e.y1&&n.obstruct(g.BOTTOM,e):n.vel.y<0&&n.bounds.top<e.y2&&n.obstruct(g.TOP,e)}const Rt=[Lt,Dt],Ft={brick:At,coin:It,ground:Rt};class Nt{constructor(){a(this,"resolvers");this.resolvers=[]}addGrid(e){this.resolvers.push(new et(e))}checkX(e,t,i){let s;if(e.vel.x>0)s=e.bounds.right;else if(e.vel.x<0)s=e.bounds.left;else return;for(const r of this.resolvers)r.searchByRange(s,s,e.bounds.top,e.bounds.bottom).forEach(l=>{this.handle(0,e,l,r,t,i)})}checkY(e,t,i){let s;if(e.vel.y>0)s=e.bounds.bottom;else if(e.vel.y<0)s=e.bounds.top;else return;for(const r of this.resolvers)r.searchByRange(e.bounds.left,e.bounds.right,s,s).forEach(l=>{this.handle(1,e,l,r,t,i)})}handle(e,t,i,s,r,o){const l={entity:t,match:i,resolver:s,gameContext:r,level:o},c=Ft[i.tile.behavior];c&&c[e](l)}}function zt(n,e){const t=new V;t.name="MARIO",n.addTrait(t);const i=new I;n.addTrait(i)}function _e(n,e){const t=n.traits.get(I);t&&t.reset();const i=n.traits.get(V);i&&(i.world=e)}function Bt(n,e){const t=n.traits.get(I);t&&(t.hurryEmitted=null),n.pos.copy(e.checkpoints[0]),e.entities.add(n)}function*ye(n){for(const e of n)e.traits.has(V)&&(yield e)}const he={TRIGGER:Symbol("trigger"),COMPLETE:"scene complete"};function Ot(n){for(const e of ye(n.entities))n.camera.pos.x=pt(e.pos.x-100,n.camera.min.x,n.camera.max.x-n.camera.size.x)}class Gt extends Set{get(e){for(const t of this)if(t.id===e)return t}}class xe extends ee{constructor(){super();a(this,"name");a(this,"checkpoints");a(this,"gravity");a(this,"totalTime");a(this,"camera");a(this,"music");a(this,"entities");a(this,"entityCollider");a(this,"tileCollider");this.name="",this.checkpoints=[],this.gravity=gt,this.totalTime=0,this.camera=new bt,this.music=new wt,this.entities=new Gt,this.entityCollider=new xt(this.entities),this.tileCollider=new Nt}draw(t){t.videoContext&&this.comp.draw(t.videoContext,this.camera)}update(t){this.entities.forEach(i=>{i.update(t,this)}),this.entities.forEach(i=>{this.entityCollider.check(i)}),this.entities.forEach(i=>{i.finalize()}),Ot(this),this.totalTime+=t.deltaTime}pause(){this.music.pause()}}a(xe,"EVENT_TRIGGER",he.TRIGGER),a(xe,"EVENT_COMPLETE",he.COMPLETE);function jt(n,e=64,t=64){const i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");if(!s)throw new Error("Failed to get 2D context for sprite buffer");return function(o,l){n.forEach(c=>{c.draw&&(s.clearRect(0,0,e,t),c.draw(s),o.drawImage(i,Math.floor(c.pos.x-l.pos.x),Math.floor(c.pos.y-l.pos.y)))})}}function $t(n,e,t){const i=new et(e),s=document.createElement("canvas");s.width=S+16,s.height=M;const r=s.getContext("2d");function o(l,c){r.clearRect(0,0,s.width,s.height);for(let d=l;d<=c;++d){const u=e.grid[d];u&&u.forEach((h,p)=>{const L=h.style;t.animations&&typeof t.animations.get=="function"&&t.animations.get(L)?t.drawAnim(L,r,d-l,p,n.totalTime):t.drawTile(h.style,r,d-l,p)})}}return function(c,d){const u=i.toIndex(d.size.x),h=i.toIndex(d.pos.x),p=h+u;o(h,p),c.drawImage(s,Math.floor(-d.pos.x%16),Math.floor(-d.pos.y))}}function tt(n){return new Promise(e=>{const t=new Image;t.addEventListener("load",()=>{e(t)}),t.src=n})}function ge(n){return fetch(n).then(e=>e.json())}class Jt{constructor(){a(this,"tracks");this.tracks=new Map}addTrack(e,t){const i=new Audio;i.loop=!0,i.src=t,this.tracks.set(e,i)}playTrack(e){this.pauseAll();const t=this.tracks.get(e);if(!t)throw new Error(`Track "${e}" not found`);return t.play(),t}pauseAll(){for(const e of this.tracks.values())e.pause()}}function Vt(n){return ge(`/music/${n}.json`).then(e=>{const t=new Jt;for(const[i,s]of Object.entries(e))t.addTrack(i,s.url);return t})}class it{constructor(e,t,i){a(this,"image");a(this,"width");a(this,"height");a(this,"tiles");a(this,"animations");this.image=e,this.width=t,this.height=i,this.tiles=new Map,this.animations=new Map}getAnimation(e){return this.animations.get(e)}defineAnim(e,t){this.animations.set(e,t)}define(e,t,i,s,r){const o=[!1,!0].map(l=>{const c=document.createElement("canvas");c.width=s,c.height=r;const d=c.getContext("2d");return d&&l&&(d.scale(-1,1),d.translate(-s,0)),d&&d.drawImage(this.image,t,i,s,r,0,0,s,r),c});this.tiles.set(e,o)}defineTile(e,t,i){this.define(e,t*this.width,i*this.height,this.width,this.height)}draw(e,t,i,s,r=!1){var l;const o=(l=this.tiles.get(e))==null?void 0:l[r?1:0];o?t.drawImage(o,i,s):console.warn(`Sprite '${e}' not found`)}drawAnim(e,t,i,s,r){const o=this.animations.get(e);o?this.drawTile(o(r),t,i,s):console.warn(`Animation '${e}' not found`)}drawTile(e,t,i,s){this.draw(e,t,i*this.width,s*this.height)}has(e){return this.tiles.has(e)}}function Ht(n,e){return function(i){const s=Math.floor(i/e)%n.length;return n[s]}}function P(n){return ge(`/sprites/${n}.json`).then(e=>Promise.all([e,tt(e.imageURL)])).then(([e,t])=>{const i=new it(t,e.tileW,e.tileH);return e.tiles&&e.tiles.forEach(s=>{i.defineTile(s.name,s.index[0],s.index[1])}),e.frames&&e.frames.forEach(s=>{i.define(s.name,s.rect[0],s.rect[1],s.rect[2],s.rect[3])}),e.animations&&e.animations.forEach(s=>{const r=Ht(s.frames,s.frameLen);i.defineAnim(s.name,r)}),i})}function qt(){class n extends m{constructor(){super();a(this,"entities");a(this,"offsetX");this.entities=[],this.offsetX=64}addEntity(i){this.entities.push(i),this.entities.sort((s,r)=>s.pos.x<r.pos.x?-1:1)}update(i,s,r){const o=r.camera.pos.x+r.camera.size.x+this.offsetX;for(;this.entities[0]&&o>this.entities[0].pos.x;)r.entities.add(this.entities.shift())}}return new n}function Kt(n){return ge(`/sprites/patterns/${n}.json`)}function Ut(n){n.events.listen(I.EVENT_TIMER_OK,()=>{n.music.playTheme()}),n.events.listen(I.EVENT_TIMER_HURRY,()=>{n.music.playHurryTheme()})}function _t(n,e,t){n.layers.forEach(i=>{const s=Zt(i.tiles,t);e.tileCollider.addGrid(s)})}function Wt(n){let e=0,t=0;for(const i of n.tileCollider.resolvers)i.tileSize>t&&(t=i.tileSize),i.matrix.forEach((s,r,o)=>{r>e&&(e=r)});n.camera.max.x=(e+1)*t}function Xt(n,e){if(!n.checkpoints){e.checkpoints.push(new f(0,0));return}n.checkpoints.forEach(([t,i])=>{e.checkpoints.push(new f(t,i))})}function Yt(n,e,t){const i=qt();n.entities.forEach(({id:r,name:o,pos:[l,c],props:d})=>{const u=t[o];if(!u)throw new Error(`No entity ${o}`);const h=u(d);h.pos.set(l,c),r?(h.id=r,e.entities.add(h)):i.addEntity(h)});const s=new T;s.addTrait(i),e.entities.add(s)}function Qt(n,e){if(n.triggers)for(const t of n.triggers){const i=new yt;i.conditions.push((r,o,l,c)=>{c.events.emit(xe.EVENT_TRIGGER,t,r,o)});const s=new T;s.addTrait(i),s.size.set(64,64),s.pos.set(t.pos[0],t.pos[1]),e.entities.add(s)}}function we(n){return function(t){return ge(`/levels/${t}.json`).then(i=>Promise.all([i,P(i.spriteSheet),Vt(i.musicSheet),Kt(i.patternSheet)])).then(([i,s,r,o])=>{const l=new xe;l.name=t,l.music.setPlayer(r),_t(i,l,o),Yt(i,l,n),Qt(i,l),Xt(i,l),Ut(l),Wt(l);for(const d of l.tileCollider.resolvers){const u=$t(l,d.matrix,s);l.comp.layers.push(u)}const c=jt(l.entities);return l.comp.layers.splice(l.comp.layers.length-1,0,c),l})}}function Zt(n,e){const t=new ft;for(const{tile:i,x:s,y:r}of ii(n,e))t.set(s,r,i);return t}function*Ae(n,e,t,i){const s=n+e,r=t+i;for(let o=n;o<s;++o)for(let l=t;l<r;++l)yield{x:o,y:l}}function ei(n){if(n.length===4){const[e,t,i,s]=n;return Ae(e,t,i,s)}else if(n.length===3){const[e,t,i]=n;return Ae(e,t,i,1)}else if(n.length===2){const[e,t]=n;return Ae(e,1,t,1)}throw new Error(`Invalid range: ${n}`)}function*ti(n){for(const e of n){const t=ei(e);t&&(yield*t)}}function*ii(n,e){function*t(i,s,r){for(const o of i)for(const{x:l,y:c}of ti(o.ranges)){const d=l+s,u=c+r;if(o.pattern)if(e[o.pattern]){const h=e[o.pattern].tiles;yield*t(h,d,u)}else console.warn(`Pattern "${o.pattern}" not found in patterns:`,e);else yield{tile:o,x:d,y:u}}}yield*t(n,0,0)}const si=" 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ©!-×.";class ni{constructor(e,t){a(this,"sprites");a(this,"size");this.sprites=e,this.size=t}print(e,t,i,s){[...e.toUpperCase()].forEach((r,o)=>{this.sprites.draw(r,t,i+o*this.size,s)})}}function ri(){return tt("./img/font.png").then(n=>{const e=new it(n,8,8),t=8,i=n.width;for(const[s,r]of[...si].entries()){const o=s*t%i,l=Math.floor(s*t/i)*t;e.define(r,o,l,t,t)}return new ni(e,t)})}class Se extends m{constructor(){super();a(this,"enabled");a(this,"speed");this.enabled=!0,this.speed=-30}obstruct(t,i){(i===g.LEFT||i===g.RIGHT)&&(this.speed=-this.speed)}update(t){this.enabled&&(t.vel.x=this.speed)}}class Je extends m{update(e,t,i){const{deltaTime:s}=t;e.pos.x+=e.vel.x*s,i.tileCollider.checkX(e,t,i),e.pos.y+=e.vel.y*s,i.tileCollider.checkY(e,t,i),e.vel.y+=i.gravity*s}}class Me extends m{constructor(){super();a(this,"obstructs");this.obstructs=!0}obstruct(t,i,s){this.obstructs&&(i===g.BOTTOM?(t.bounds.bottom=s.y1,t.vel.y=0):i===g.TOP?(t.bounds.top=s.y2,t.vel.y=0):i===g.LEFT?(t.bounds.left=s.x2,t.vel.x=0):i===g.RIGHT&&(t.bounds.right=s.x1,t.vel.x=0))}}function ai(){return P("goomba-brown").then(st)}function oi(){return P("goomba-blue").then(st)}let li=class extends m{collides(e,t){const i=e.getKillableTrait();if(!(i!=null&&i.dead)&&t.traits.has(J))if(t.vel.y>e.vel.y){const s=e.getKillableTrait(),r=e.getPendulumMoveTrait();s&&s.kill(),r&&(r.speed=0)}else{const s=t.getKillableTrait();s&&s.kill()}}};function st(n){const e=n.getAnimation("walk");function t(s){const r=s.getKillableTrait();return r!=null&&r.dead?"flat":e?e(s.lifetime):"walk-1"}function i(s){n.draw(t(this),s,0,0)}return function(r){const o=new T;return o.size.set(16,16),(r==null?void 0:r.startX)!==void 0&&(r==null?void 0:r.startY)!==void 0&&o.pos.set(r.startX,r.startY),o.addTrait(new Je),o.addTrait(new Me),o.addTrait(new Se),o.addTrait(new li),o.addTrait(new w),o.isActive=!0,o.activate=function(){this.isActive=!0},o.deactivate=function(){this.isActive=!1},o.getEnemyType=function(){return"goomba"},o.draw=i,o}}function ci(){return P("koopa-green").then(nt)}function di(){return P("koopa-blue").then(nt)}const oe=Symbol("walking"),X=Symbol("hiding"),ce=Symbol("panic");let We=class extends m{constructor(){super();a(this,"hideTime");a(this,"hideDuration");a(this,"walkSpeed");a(this,"panicSpeed");a(this,"state");this.hideTime=0,this.hideDuration=5,this.walkSpeed=null,this.panicSpeed=300,this.state=oe}collides(t,i){const s=t.traits.get(w);s!=null&&s.dead||i.traits.has(J)&&(i.vel.y>t.vel.y?this.handleStomp(t,i):this.handleNudge(t,i))}handleNudge(t,i){if(this.state===oe){const s=i.traits.get(w);s&&s.kill()}else if(this.state===X)this.panic(t,i);else if(this.state===ce){const s=Math.sign(t.vel.x),r=Math.sign(t.pos.x-i.pos.x);if(s!==0&&s!==r){const o=i.traits.get(w);o&&o.kill()}}}handleStomp(t,i){if(this.state===oe)this.hide(t);else if(this.state===X){const s=t.traits.get(w);s&&s.kill(),t.vel.set(100,-200);const r=t.traits.get(Me);r&&(r.obstructs=!1)}else this.state===ce&&this.hide(t)}hide(t){t.vel.x=0,t.traits.forEach(i=>{i instanceof Se&&this.walkSpeed===null&&(this.walkSpeed=0)}),this.hideTime=0,this.state=X}unhide(t){this.state=oe}panic(t,i){t.vel.x=this.panicSpeed*Math.sign(i.vel.x),this.state=ce}update(t,i){const s=i.deltaTime;t.traits.forEach(r=>{r instanceof Se&&(this.state===oe?t.vel.x=this.walkSpeed||-30:this.state===X?t.vel.x=0:this.state)}),this.state===X&&(this.hideTime+=s,this.hideTime>this.hideDuration&&this.unhide(t))}};function nt(n){function e(i){const s=i.traits.get(We);return(s==null?void 0:s.state)===X?s.hideTime>3?`wake-${Math.floor(s.hideTime*2)%3}`:"hiding":(s==null?void 0:s.state)===ce?"hiding":`walk-${Math.floor(i.lifetime*6)%2}`}function t(i){const s=e(this);n.draw(s,i,0,0,this.vel.x<0)}return function(){const s=new T;return s.size.set(16,16),s.offset.y=8,s.addTrait(new Je),s.addTrait(new Me),s.addTrait(new Se),s.addTrait(new w),s.addTrait(new We),s.draw=t,s}}function hi(){return P("piranha-plant").then(fi)}let ui=class extends m{constructor(){super();a(this,"graceDistance");a(this,"idleTime");a(this,"idleCounter");a(this,"attackTime");a(this,"attackCounter");a(this,"holdTime");a(this,"holdCounter");a(this,"retreatTime");a(this,"retreatCounter");a(this,"velocity");a(this,"deltaMove");this.graceDistance=32,this.idleTime=4,this.idleCounter=0,this.attackTime=2,this.attackCounter=null,this.holdTime=2,this.holdCounter=null,this.retreatTime=2,this.retreatCounter=null,this.velocity=30,this.deltaMove=0}update(t,i,s){const{deltaTime:r}=i;if(this.idleCounter!==null){for(const o of ye(s.entities))if(o.bounds.getCenter().distance(t.bounds.getCenter())<this.graceDistance){this.idleCounter=0;return}this.idleCounter+=r,this.idleCounter>=this.idleTime&&(this.attackCounter=0,this.idleCounter=null)}else if(this.attackCounter!==null){this.attackCounter+=r;const o=this.velocity*r;this.deltaMove+=o,t.pos.y-=o,this.deltaMove>=t.size.y&&(t.pos.y+=t.size.y-this.deltaMove,this.attackCounter=null,this.holdCounter=0)}else if(this.holdCounter!==null)this.holdCounter+=r,this.holdCounter>=this.holdTime&&(this.retreatCounter=0,this.holdCounter=null);else if(this.retreatCounter!==null){this.retreatCounter+=r;const o=this.velocity*r;this.deltaMove-=o,t.pos.y+=o,this.deltaMove<=0&&(t.pos.y-=this.deltaMove,this.retreatCounter=null,this.idleCounter=0)}}};function fi(n){const e=n.animations.get("chew");function t(s){return e(s.lifetime)}function i(s){n.draw(t(this),s,0,0)}return function(){const r=new T;return r.size.set(16,24),r.addTrait(new ui),r.draw=i,r}}class rt extends m{update(e,t,i){e.vel.y+=i.gravity}}class at extends m{update(e,{deltaTime:t},i){e.pos.x+=e.vel.x*t,e.pos.y+=e.vel.y*t}}function pi(){return P("bullet").then(yi)}class mi extends m{constructor(){super();a(this,"gravity");this.gravity=new rt}collides(t,i){const s=t.traits.get(w);s!=null&&s.dead||(console.log("Collision in Bullet",i.vel.y),i.traits.has(J)&&(i.vel.y>t.vel.y?(t.traits.get(w).kill(),t.vel.set(100,-200)):i.traits.get(w).kill()))}update(t,i,s){const r=t.traits.get(w);r!=null&&r.dead&&this.gravity.update(t,i,s)}}function yi(n){function e(t){n.draw("bullet",t,0,0,this.vel.x>0)}return function(){const i=new T;return i.size.set(16,14),i.addTrait(new at),i.addTrait(new mi),i.addTrait(new w),i.draw=e,i}}class gi extends m{constructor(){super();a(this,"interval");a(this,"coolDown");a(this,"emitters");this.interval=2,this.coolDown=this.interval,this.emitters=[]}emit(t,i,s){for(const r of this.emitters)r(t,i,s)}update(t,i,s){const{deltaTime:r}=i;this.coolDown-=r,this.coolDown<=0&&(this.emit(t,i,s),this.coolDown=this.interval)}setInterval(t){this.interval=t}getInterval(){return this.interval}addEmitter(t){this.emitters.push(t)}}function ve(n,e){const t=vi(e);return ge(`/sounds/${n}.json`).then(i=>{const s=new Ze,r=i.fx;return Promise.all(Object.keys(r).map(o=>t(r[o].url).then(l=>{s.addAudio(o,l)}))).then(()=>s)})}function vi(n){return function(t){return fetch(t).then(i=>i.arrayBuffer()).then(i=>n.decodeAudioData(i))}}const Xe=30;function bi(n){return ve("cannon",n).then(e=>wi(e))}function wi(n){function e(t,i,s){let r=1;for(const l of ye(s.entities)){if(l.pos.x>t.pos.x-Xe&&l.pos.x<t.pos.x+Xe)return;l.pos.x<t.pos.x&&(r=-1)}const o=i.entityFactory.bullet();o.pos.copy(t.pos),o.vel.set(80*r,0),t.sounds.add("shoot"),s.entities.add(o)}return function(){const i=new T;i.audio=n;const s=new gi;return s.setInterval(4),s.addEmitter(e),i.addTrait(s),i}}class xi extends m{constructor(){super();a(this,"time");this.time=2}update(t,i,s){t.lifetime>this.time&&this.queue(()=>{s.entities.delete(t)})}}function Si(n){return Promise.all([P("brick-shrapnel"),ve("brick-shrapnel",n)]).then(([e,t])=>Ei(e,t))}function Ei(n,e){function t(i){n.drawAnim("spinning-brick",i,0,0,this.lifetime)}return function(){const s=new T;return s.audio=e,s.size.set(8,8),s.addTrait(new xi),s.addTrait(new rt),s.addTrait(new at),s.draw=t,s}}class de extends m{constructor(){super();a(this,"direction");a(this,"movement");a(this,"distance");this.direction=new f(0,0),this.movement=new f(0,0),this.distance=new f(0,0)}}function Ti(){return{time:0,start:new f(0,0),end:new f(0,0)}}function ki(n,e){const t=n.traits.get(me);t&&(ae.center(n,e),t.direction.equals(le.UP)?ae.bottom(n,e):t.direction.equals(le.DOWN)?ae.top(n,e):t.direction.equals(le.LEFT)?ae.right(n,e):t.direction.equals(le.RIGHT)&&ae.left(n,e),t.addTraveller(n,e))}const Ce=class Ce extends m{constructor(){super();a(this,"duration");a(this,"direction");a(this,"travellers");this.duration=1,this.direction=new f(0,0),this.travellers=new Map}addTraveller(t,i){i.traits.get(de).distance.set(0,0);const r=Ti();r.start.copy(i.pos),r.end.copy(i.pos),r.end.x+=this.direction.x*t.size.x,r.end.y+=this.direction.y*t.size.y,this.travellers.set(i,r)}collides(t,i){if(!i.traits.has(de)||this.travellers.has(i))return;if(i.traits.get(de).direction.equals(this.direction)){const r=i.bounds,o=t.bounds;if(this.direction.x&&(r.top<o.top||r.bottom>o.bottom)||this.direction.y&&(r.left<o.left||r.right>o.right))return;t.sounds.add("pipe"),this.addTraveller(t,i)}}update(t,i,s){const{deltaTime:r}=i;for(const[o,l]of this.travellers.entries()){l.time+=r;const c=l.time/this.duration;o.pos.x=l.start.x+(l.end.x-l.start.x)*c,o.pos.y=l.start.y+(l.end.y-l.start.y)*c,o.vel.set(0,0);const d=o.traits.get(de);d.movement.copy(this.direction),d.distance.x=o.pos.x-l.start.x,d.distance.y=o.pos.y-l.start.y,l.time>this.duration&&(this.travellers.delete(o),d.movement.set(0,0),d.distance.set(0,0),s.events.emit(Ce.EVENT_PIPE_COMPLETE,t,o))}}};a(Ce,"EVENT_PIPE_COMPLETE",Symbol("pipe complete"));let me=Ce;function Ci(n){return Promise.all([ve("pipe-portal",n)]).then(([e])=>Mi(e))}function Mi(n){return function(t){const i=new me;i.direction.copy(le[t.dir]);const s=new T;return s.props=t,s.audio=n,s.size.set(24,30),s.addTrait(i),s}}class ot extends m{constructor(){super();a(this,"distance");a(this,"velocity");a(this,"handled");this.distance=0,this.velocity=100,this.handled=!1}setHandled(t){this.handled=t}isHandled(){return this.handled}getDistance(){return this.distance}setDistance(t){this.distance=t}getVelocity(){return this.velocity}setVelocity(t){this.velocity=t}update(t,i,s){}}a(ot,"FLAG_TOP_POS",Symbol("flag top position"));function Pi(n){return Promise.all([ve("flag-pole",n)]).then(([e])=>Ai(e))}function Ai(n){return function(){const t=new T,i=new ot;return t.audio=n,t.size.set(8,144),t.offset.set(4,0),t.addTrait(i),t}}class lt extends m{constructor(){super();a(this,"ready");a(this,"duration");a(this,"engageTime");a(this,"requestTime");a(this,"gracePeriod");a(this,"speedBoost");a(this,"velocity");this.ready=0,this.duration=.3,this.engageTime=0,this.requestTime=0,this.gracePeriod=.1,this.speedBoost=.3,this.velocity=200}get falling(){return this.ready<0}start(){this.requestTime=this.gracePeriod,console.log("Jump.start() called, requestTime:",this.requestTime)}cancel(){this.engageTime=0,this.requestTime=0,console.log("Jump.cancel() called")}obstruct(t,i){i===g.BOTTOM?this.ready=1:i===g.TOP&&this.cancel()}update(t,i,s){const{deltaTime:r}=i;this.requestTime>0&&(console.log("Jump update: ready =",this.ready,"requestTime =",this.requestTime.toFixed(3)),this.ready>0&&(console.log("Starting jump!"),t.sounds.add("jump"),this.engageTime=this.duration,this.requestTime=0),this.requestTime-=r),this.engageTime>0&&(t.vel.y=-(this.velocity+Math.abs(t.vel.x)*this.speedBoost),console.log("Jump engaged: vel.y =",t.vel.y.toFixed(2),"engageTime =",this.engageTime.toFixed(3)),this.engageTime-=r),this.ready--}}class Ii extends m{constructor(){super();a(this,"dir");a(this,"acceleration");a(this,"deceleration");a(this,"dragFactor");a(this,"distance");a(this,"heading");a(this,"lastVelX");a(this,"isMoving");this.dir=0,this.acceleration=400,this.deceleration=300,this.dragFactor=1/5e3,this.distance=0,this.heading=1,this.lastVelX=0,this.isMoving=!1}update(t,i,s){const{deltaTime:r}=i,o=Math.abs(t.vel.x);if(Math.abs(this.lastVelX-t.vel.x)>.5&&console.log(`Velocity changed from ${this.lastVelX.toFixed(2)} to ${t.vel.x.toFixed(2)}`),this.dir!==0){t.vel.x+=this.acceleration*r*this.dir;const d=t.traits.get(lt);d?d.falling||(this.heading=this.dir):this.heading=this.dir,this.isMoving=!0}else if(t.vel.x!==0){const d=Math.min(o,this.deceleration*r);t.vel.x+=t.vel.x>0?-d:d,o<1&&(t.vel.x=0,this.isMoving&&(console.log("Stopping movement, resetting distance"),this.distance=0,this.isMoving=!1))}else this.isMoving&&(console.log("Entity stopped, resetting distance"),this.distance=0,this.isMoving=!1);const c=this.dragFactor*t.vel.x*o;t.vel.x-=c,o>1&&(this.distance+=o*r),this.lastVelX=t.vel.x}}class Li extends m{constructor(){super();a(this,"distance");this.distance=0}}const Y={PRESS:Symbol("press"),RELEASE:Symbol("release")},Di=1/1e3,Ri=1/5e3;function Fi(n){return Promise.all([P("mario"),ve("mario",n)]).then(([e,t])=>Ni(e,t))}function Ni(n,e){(()=>{const l=["idle","jump","run-1","run-2","run-3","break"].filter(c=>!n.has(c));l.length>0&&(console.warn("Missing Mario sprite frames:",l),l.forEach(c=>{n.has("idle")&&n.define(c,0,88,16,16)}))})();function i(o){const l=o.getGoTrait();return l!=null&&l.heading?l.heading<0:!1}function s(o){const l=o.getJumpTrait();if(l!=null&&l.falling)return"jump";const c=o.getGoTrait();if((c==null?void 0:c.distance)!==void 0&&c.distance>0){if(o.vel.x>0&&c.dir!==void 0&&c.dir<0||o.vel.x<0&&c.dir!==void 0&&c.dir>0)return"break";if(c.distance<10)return"run-1";{const d=Math.floor(c.distance/10)%3;return["run-1","run-2","run-3"][d]}}return"idle"}function r(o){let l=s(this);const c=i(this);n.has(l)||(console.warn(`Mario frame "${l}" not found, falling back to idle`),l="idle");try{n.draw(l,o,0,0,c)}catch(d){console.error(`Failed to draw Mario with frame ${l}:`,d),o.fillStyle="red",o.fillRect(0,0,16,16)}}return function(l){const c=new T;c.audio=e,(l==null?void 0:l.startX)!==void 0&&(l==null?void 0:l.startY)!==void 0&&c.pos.set(l.startX,l.startY),c.size.set(14,16),c.addTrait(new Je),c.addTrait(new Me),c.addTrait(new Ii),c.addTrait(new lt),c.addTrait(new w),c.addTrait(new J),c.addTrait(new de),c.addTrait(new Li);const d=c.getKillableTrait();d&&(d.removeAfter=1/0);const u=c.getJumpTrait();return u&&(u.velocity=(l==null?void 0:l.jumpVelocity)||175),c.turbo=function(h){const p=this.getGoTrait();p&&(p.dragFactor=h?Ri:Di)},c.draw=r,c.turbo(!1),c.receive=function(h){if(h.action==="jump"){const p=this.getJumpTrait();p&&(h.type===Y.PRESS?p.start():p.cancel())}else if(h.action==="move"){const p=this.getGoTrait();if(p&&typeof h.direction=="number"){const L=typeof h.keyState=="number"?h.keyState:0;p.dir+=L?h.direction:-h.direction}}else if(h.action==="turbo"){const p=typeof h.keyState=="number"?h.keyState:0;this.turbo(p===1)}},c}}function zi(n){const e=[];return function(i){for(let r=0;r<n;r++)e.push(i());let s=0;return function(o){const l=e[s++%e.length];return l.lifetime=0,o&&Object.entries(o).forEach(([c,d])=>{l[c]=d}),l}}}async function Bi(n){const e={mario:void 0,goomba:void 0,koopa:void 0,piranha:void 0,flagpole:void 0,bullet:void 0,cannon:void 0};function t(s){return s(n).then(r=>o=>{try{return r(o)}catch(l){throw console.error("Entity factory error:",l),l}})}function i(s){return function(o){e[s]=o}}return await Promise.all([t(Fi).then(i("mario")),t(hi).then(i("piranha")),t(ai).then(i("goomba-brown")),t(oi).then(i("goomba-blue")),t(ci).then(i("koopa-green")),t(di).then(i("koopa-blue")),t(pi).then(i("bullet")),t(bi).then(i("cannon")),t(Ci).then(i("pipe-portal")),t(Pi).then(i("flagpole")),t(Si).then(zi(8)).then(i("brickShrapnel"))]),e}function Ye(n){return function(t){t.fillStyle=n,t.fillRect(0,0,t.canvas.width,t.canvas.height)}}function Oi(n,e){const t=n.size;return function(s){const r=e.length,o=Math.floor(s.canvas.width/t),l=Math.floor(s.canvas.height/t),c=o/2-r/2,d=l/2;n.print(e,s,c*t,d*t)}}function Qe(n,e){const t=n.size*2,i=n.size*3;return function(r){const o=e.traits.get(V),l=e.traits.get(I);n.print(o.name,r,24,t),n.print(o.score.toString().padStart(6,"0"),r,24,i),n.print("×"+o.coins.toString().padStart(2,"0"),r,96,i),n.print("WORLD",r,144,t),n.print(o.world,r,152,i),n.print("TIME",r,200,t),n.print(l.currentTime.toFixed().toString().padStart(3,"0"),r,208,i)}}function Gi(n){for(const e of ye(n))return e}function ji(n,e){const t=n.size,i=document.createElement("canvas");i.width=32,i.height=32;const s=i.getContext("2d");return function(o){var d;const l=Gi(e.entities);if(!l)return;const c=l.traits.get(V);c&&(n.print("WORLD "+e.name,o,t*12,t*12),n.print("×"+c.lives.toString().padStart(3," "),o,t*16,t*16),s&&(s.clearRect(0,0,i.width,i.height),(d=l.draw)==null||d.call(l,s),o.drawImage(i,t*13,t*15)))}}class $i{constructor(){a(this,"sceneIndex");a(this,"scenes");this.sceneIndex=-1,this.scenes=[]}addScene(e){e.onComplete(()=>{this.runNext()}),this.scenes.push(e)}runNext(){const e=this.scenes[this.sceneIndex];e&&e.pause(),this.sceneIndex++}update(e){const t=this.scenes[this.sceneIndex];t&&(t.update(e),t.draw(e))}}class Ji extends ee{constructor(){super();a(this,"countDown");this.countDown=2}update(t){this.countDown-=t.deltaTime,this.countDown<=0&&this.complete()}}const R=class R{constructor(){a(this,"audioContext");a(this,"videoContext");a(this,"entityFactory");a(this,"font");a(this,"deltaTime");a(this,"tick");a(this,"paused");this.audioContext=new AudioContext,this.videoContext=null,this.entityFactory=null,this.font=null,this.deltaTime=0,this.tick=0,this.paused=!1}static getInstance(){return R.instance||(R.instance=new R),R.instance}init(e){this.videoContext=e}setEntityFactory(e){this.entityFactory=e}setFont(e){this.font=e}update(e){this.paused||(this.deltaTime=e,this.tick++)}pause(){this.paused=!0,this.audioContext.suspend()}resume(){this.paused=!1,this.audioContext.resume()}toggleMusic(){b.musicEnabled=!b.musicEnabled}toggleSound(){b.soundEnabled=!b.soundEnabled}isMusicEnabled(){return b.musicEnabled}isSoundEnabled(){return b.soundEnabled}stopAllSounds(){this.audioContext.close(),this.audioContext=new AudioContext}getGameContext(){return{audioContext:this.audioContext,videoContext:this.videoContext,entityFactory:this.entityFactory,deltaTime:this.deltaTime,tick:this.tick}}};a(R,"instance");let De=R;const Ie=1,Le=0;class Vi{constructor(){a(this,"keyStates");a(this,"keyMap");a(this,"blocked");this.keyStates=new Map,this.keyMap=new Map,this.blocked=!1}addMapping(e,t){this.keyMap.set(e,t)}handleEvent(e){if(this.blocked)return;const{code:t}=e;if(!this.keyMap.has(t))return;e.preventDefault();const i=e.type==="keydown"?Ie:Le;if(this.keyStates.get(t)===i)return;this.keyStates.set(t,i),console.log(`Key ${t} ${i===Ie?"pressed":"released"}`);const s=this.keyMap.get(t);s&&s(i)}listenTo(e){["keydown","keyup"].forEach(t=>{e.addEventListener(t,i=>{this.handleEvent(i)})}),e.addEventListener("blur",()=>{this.resetAllKeys()})}resetAllKeys(){[...this.keyStates.keys()].forEach(t=>{if(this.keyStates.get(t)===Ie){this.keyStates.set(t,Le);const i=this.keyMap.get(t);i&&i(Le)}})}block(){this.blocked=!0}unblock(){this.blocked=!1}}class Hi{constructor(){a(this,"receivers");this.receivers=new Set}addReceiver(e){this.receivers.add(e)}dropReceiver(e){this.receivers.delete(e)}route(e){for(const t of this.receivers)e(t)}}const Q=1,W=0;class y{constructor(e,t){a(this,"name");a(this,"type");a(this,"action");a(this,"keyState");a(this,"direction");this.action=e,this.name=Symbol(e),this.type=Y.PRESS,t!==void 0&&(typeof t=="number"?(this.keyState=t,this.type=t===Q?Y.PRESS:Y.RELEASE):(t.keyState!==void 0&&(this.keyState=t.keyState,this.type=t.keyState===Q?Y.PRESS:Y.RELEASE),t.direction!==void 0&&(this.direction=t.direction)))}}const F=class F{constructor(){a(this,"receivers");a(this,"keyboardState");a(this,"inputRouter");a(this,"touchControlsEnabled");a(this,"touchButtons");a(this,"virtualJoystick");a(this,"pauseHandler");a(this,"keysPressed");this.receivers=new Set,this.keyboardState=new Vi,this.inputRouter=new Hi,this.touchControlsEnabled=!1,this.touchButtons=new Map,this.virtualJoystick=null,this.pauseHandler=null,this.keysPressed=new Set,this.detectTouchDevice()}static getInstance(){return F.instance||(F.instance=new F),F.instance}init(e){this.setupKeyboard(),this.keyboardState.listenTo(e),e.addEventListener("keydown",t=>this.handleKeyEvent(t,!0)),e.addEventListener("keyup",t=>this.handleKeyEvent(t,!1)),this.touchControlsEnabled&&this.createTouchControls()}handleKeyEvent(e,t){const{code:i}=e;if(t){if(this.keysPressed.has(i))return;this.keysPressed.add(i)}else this.keysPressed.delete(i);i==="KeyA"||i==="ArrowLeft"?this.triggerDirectionalInput("left",t):i==="KeyD"||i==="ArrowRight"?this.triggerDirectionalInput("right",t):i==="KeyW"||i==="ArrowUp"||i==="Space"?this.triggerActionInput("jump",t):i==="KeyS"||i==="ArrowDown"||i==="ShiftLeft"?this.triggerActionInput("turbo",t):i==="Escape"&&t&&this.pauseHandler&&this.pauseHandler()}setupKeyboard(){this.keyboardState.addMapping("KeyP",e=>{e&&this.inputRouter.route(t=>{t.receive&&t.receive(new y("pause"))})}),this.keyboardState.addMapping("Space",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("jump",e))})}),this.keyboardState.addMapping("KeyA",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("move",{direction:-1,keyState:e}))})}),this.keyboardState.addMapping("KeyD",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("move",{direction:1,keyState:e}))})}),this.keyboardState.addMapping("KeyW",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("climb",{direction:-1,keyState:e}))})}),this.keyboardState.addMapping("KeyS",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("climb",{direction:1,keyState:e}))})}),this.keyboardState.addMapping("ShiftLeft",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("turbo",e))})}),this.keyboardState.addMapping("ArrowRight",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("move",{direction:1,keyState:e}))})}),this.keyboardState.addMapping("ArrowLeft",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("move",{direction:-1,keyState:e}))})}),this.keyboardState.addMapping("ArrowUp",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("jump",e))})}),this.keyboardState.addMapping("ArrowDown",e=>{this.inputRouter.route(t=>{t.receive&&t.receive(new y("turbo",e))})})}detectTouchDevice(){("ontouchstart"in window||navigator.maxTouchPoints>0)&&(this.touchControlsEnabled=!0,this.createTouchControls())}createTouchControls(){const e=document.createElement("div");e.id="touch-controls",e.style.position="absolute",e.style.bottom="10px",e.style.left="0",e.style.right="0",e.style.display="flex",e.style.justifyContent="space-between",e.style.pointerEvents="none";const t=document.createElement("div");t.style.width="120px",t.style.height="120px",t.style.position="relative",t.style.margin="10px",t.style.pointerEvents="auto";const i=document.createElement("div");i.style.width="60px",i.style.height="60px",i.style.borderRadius="50%",i.style.backgroundColor="rgba(255, 255, 255, 0.3)",i.style.border="2px solid rgba(255, 255, 255, 0.5)",i.style.position="absolute",i.style.left="30px",i.style.top="30px",i.style.transform="translate(-50%, -50%)",i.style.transition="none",t.appendChild(i);const s=document.createElement("div");s.style.width="120px",s.style.height="120px",s.style.borderRadius="50%",s.style.backgroundColor="rgba(0, 0, 0, 0.2)",s.style.position="absolute",s.style.left="0",s.style.top="0",t.appendChild(s),t.appendChild(i),this.virtualJoystick={element:i,centerPos:new f(60,60),currentPos:new f(60,60),active:!1};const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.margin="10px",r.style.gap="10px";const o=this.createTouchButton("Jump","rgba(0, 200, 0, 0.4)",60,60);o.style.marginBottom="10px";const l=this.createTouchButton("Turbo","rgba(200, 0, 0, 0.4)",50,50),c=this.createTouchButton("⏸️","rgba(200, 200, 0, 0.4)",40,40);c.style.marginTop="auto",c.style.fontSize="16px",r.appendChild(o),r.appendChild(l),r.appendChild(c),this.touchButtons.set("jump",{element:o,pressed:!1}),this.touchButtons.set("turbo",{element:l,pressed:!1}),this.touchButtons.set("pause",{element:c,pressed:!1}),e.appendChild(t),e.appendChild(r),document.body.appendChild(e),this.setupTouchListeners(t)}createTouchButton(e,t,i,s){const r=document.createElement("div");return r.textContent=e,r.style.width=`${i}px`,r.style.height=`${s}px`,r.style.borderRadius="50%",r.style.backgroundColor=t,r.style.border="2px solid rgba(255, 255, 255, 0.5)",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.color="white",r.style.fontFamily="sans-serif",r.style.fontSize="14px",r.style.userSelect="none",r.style.pointerEvents="auto",r}setupTouchListeners(e){e.addEventListener("touchstart",i=>{i.preventDefault(),this.virtualJoystick&&(this.virtualJoystick.active=!0,this.handleJoystickMove(i.touches[0].clientX,i.touches[0].clientY,e))}),e.addEventListener("touchmove",i=>{i.preventDefault(),this.virtualJoystick&&this.virtualJoystick.active&&this.handleJoystickMove(i.touches[0].clientX,i.touches[0].clientY,e)});const t=()=>{this.virtualJoystick&&(this.virtualJoystick.active=!1,this.virtualJoystick.element.style.left=`${this.virtualJoystick.centerPos.x}px`,this.virtualJoystick.element.style.top=`${this.virtualJoystick.centerPos.y}px`,this.virtualJoystick.currentPos=new f(this.virtualJoystick.centerPos.x,this.virtualJoystick.centerPos.y),this.inputRouter.route(i=>{i.receive&&i.receive(new y("move",{direction:0,keyState:W}))}))};e.addEventListener("touchend",()=>t()),e.addEventListener("touchcancel",()=>t());for(const[i,s]of this.touchButtons.entries())s.element.addEventListener("touchstart",r=>{r.preventDefault(),s.pressed=!0,i==="pause"?(this.pauseHandler&&this.pauseHandler(),this.inputRouter.route(o=>{o.receive&&o.receive(new y("pause"))})):this.inputRouter.route(o=>{o.receive&&o.receive(new y(i,Q))})}),s.element.addEventListener("touchend",r=>{r.preventDefault(),s.pressed=!1,i!=="pause"&&this.inputRouter.route(o=>{o.receive&&o.receive(new y(i,W))})}),s.element.addEventListener("touchcancel",r=>{r.preventDefault(),s.pressed=!1,i!=="pause"&&this.inputRouter.route(o=>{o.receive&&o.receive(new y(i,W))})})}handleJoystickMove(e,t,i){if(!this.virtualJoystick)return;const s=i.getBoundingClientRect(),r=s.left+this.virtualJoystick.centerPos.x,o=s.top+this.virtualJoystick.centerPos.y;let l=e-r,c=t-o;const d=Math.sqrt(l*l+c*c),u=40;if(d>u&&(l=l*u/d,c=c*u/d),this.virtualJoystick.element.style.left=`${this.virtualJoystick.centerPos.x+l}px`,this.virtualJoystick.element.style.top=`${this.virtualJoystick.centerPos.y+c}px`,this.virtualJoystick.currentPos=new f(this.virtualJoystick.centerPos.x+l,this.virtualJoystick.centerPos.y+c),Math.abs(l)>10){const h=l>0?1:-1;this.inputRouter.route(p=>{p.receive&&p.receive(new y("move",{direction:h,keyState:Q}))})}else this.inputRouter.route(h=>{h.receive&&h.receive(new y("move",{direction:0,keyState:W}))})}addReceiver(e){this.receivers.add(e),this.inputRouter.addReceiver(e)}removeReceiver(e){this.receivers.delete(e),this.inputRouter.dropReceiver(e)}update(){}triggerDirectionalInput(e,t){const i=t?Q:W;switch(e){case"left":this.inputRouter.route(s=>{s.receive&&s.receive(new y("move",{direction:-1,keyState:i}))});break;case"right":this.inputRouter.route(s=>{s.receive&&s.receive(new y("move",{direction:1,keyState:i}))});break;case"up":this.inputRouter.route(s=>{s.receive&&s.receive(new y("jump",i))});break;case"down":this.inputRouter.route(s=>{s.receive&&s.receive(new y("turbo",i))});break}}triggerActionInput(e,t){const i=t?Q:W;switch(e){case"jump":this.inputRouter.route(s=>{s.receive&&s.receive(new y("jump",i))});break;case"run":this.inputRouter.route(s=>{s.receive&&s.receive(new y("turbo",i))});break}}setPauseHandler(e){this.pauseHandler=e}};a(F,"instance");let Re=F;const N=class N{constructor(){a(this,"debugElements");a(this,"container");a(this,"debugValues");this.debugElements=new Map,this.debugValues=new Map,this.container=null}static getInstance(){return N.instance||(N.instance=new N),N.instance}init(){this.container||(this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.top="10px",this.container.style.right="10px",this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.container.style.color="white",this.container.style.padding="10px",this.container.style.fontFamily="monospace",this.container.style.fontSize="12px",this.container.style.zIndex="1000",this.container.style.display=b.debugEnabled?"block":"none",document.body.appendChild(this.container))}set(e,t){var s;if(this.container||this.init(),!b.debugEnabled)return;this.debugValues.set(e,t);let i=this.debugElements.get(e);i||(i=document.createElement("div"),i.dataset.key=e,(s=this.container)==null||s.appendChild(i),this.debugElements.set(e,i)),i.textContent=`${e}: ${t}`}toggle(){b.debugEnabled=!b.debugEnabled,this.container&&(this.container.style.display=b.debugEnabled?"block":"none")}clear(){this.debugElements.clear(),this.debugValues.clear(),this.container&&(this.container.innerHTML="")}isEnabled(){return b.debugEnabled}getAll(){const e={};return this.debugValues.forEach((t,i)=>{e[i]=t}),e}};a(N,"instance");let Fe=N;const z=class z{constructor(){a(this,"STORAGE_KEY","super-mario-save")}static getInstance(){return z.instance||(z.instance=new z),z.instance}saveGame(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Failed to save game:",t)}}loadGame(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Failed to load game:",e),null}}hasSave(){return localStorage.getItem(this.STORAGE_KEY)!==null}deleteSave(){localStorage.removeItem(this.STORAGE_KEY)}createSaveState(e,t){return{levelName:t.name,position:{x:e.pos.x,y:e.pos.y},timestamp:Date.now()}}};a(z,"instance");let Ne=z;const B=class B{constructor(){a(this,"assets");a(this,"baseUrl");a(this,"audioContext");this.assets=new Map,this.baseUrl="",this.audioContext=null}static getInstance(){return B.instance||(B.instance=new B),B.instance}setBaseUrl(e){this.baseUrl=e.endsWith("/")?e:e+"/"}registerAsset(e,t,i){this.assets.set(e,{type:i,url:t,loaded:!1})}registerAssets(e,t){Object.entries(e).forEach(([i,s])=>{this.registerAsset(i,s,t)})}async loadAll(e){const t=this.assets.size;let i=0;const s=Array.from(this.assets.entries()).map(async([r,o])=>{try{const l=await this.loadAsset(o.type,this.baseUrl+o.url);this.assets.set(r,{...o,data:l,loaded:!0}),i++,e&&e({total:t,loaded:i,percentage:Math.round(i/t*100)})}catch(l){console.error(`Failed to load asset ${r} (${o.url}):`,l)}});await Promise.all(s)}async loadAsset(e,t){switch(e){case"image":return this.loadImage(t);case"audio":return this.loadAudio(t);case"json":return this.loadJson(t);case"text":return this.loadText(t);default:throw new Error(`Unsupported asset type: ${e}`)}}loadImage(e){return new Promise((t,i)=>{const s=new Image;s.onload=()=>t(s),s.onerror=()=>i(new Error(`Failed to load image: ${e}`)),s.src=e})}loadAudio(e){return this.audioContext||(this.audioContext=new AudioContext),fetch(e).then(t=>t.arrayBuffer()).then(t=>this.audioContext.decodeAudioData(t))}loadJson(e){return fetch(e).then(t=>t.json())}loadText(e){return fetch(e).then(t=>t.text())}get(e){const t=this.assets.get(e);return t!=null&&t.loaded?t.data:void 0}isLoaded(e){const t=this.assets.get(e);return!!(t!=null&&t.loaded)}unloadAsset(e){const t=this.assets.get(e);return t!=null&&t.loaded?(this.assets.set(e,{...t,data:void 0,loaded:!1}),!0):!1}unloadAll(){this.assets.forEach((e,t)=>{e.loaded&&this.assets.set(t,{...e,data:void 0,loaded:!1})}),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}registerGameAssets(){this.registerAssets({mario:`${v.sprites}/mario.json`,goomba:`${v.sprites}/goomba.json`,koopa:`${v.sprites}/koopa.json`,items:`${v.sprites}/items.json`,tiles:`${v.sprites}/tiles.json`},"json"),this.registerAssets({jump:`${v.audio}/jump.mp3`,coin:`${v.audio}/coin.mp3`,stomp:`${v.audio}/stomp.mp3`,theme:`${v.audio}/theme.mp3`,gameOver:`${v.audio}/game-over.mp3`},"audio"),this.registerAssets({"level1-1":`${v.levels}/1-1.json`,"level1-2":`${v.levels}/1-2.json`,"level1-3":`${v.levels}/1-3.json`},"json")}async preloadEssentialAssets(){try{return Promise.resolve()}catch(e){return console.warn("Failed to preload essential assets, using fallbacks:",e),Promise.resolve()}}preloadAllInBackground(e){try{e&&e({total:1,loaded:1,percentage:100})}catch(t){console.warn("Error in background asset loading:",t)}}};a(B,"instance");let ze=B;const A=class A{constructor(){a(this,"levelLoader",null)}static getInstance(){return A.instance||(A.instance=new A),A.instance}async initLevelLoader(e){this.levelLoader=await we(e)}static async getLevel(e,t){const i=A.getInstance(),s=t||i.levelLoader;if(!s)throw new Error("Level loader not initialized");return s(e)}async loadLevel(e){if(!this.levelLoader)throw new Error("Level loader not initialized");return this.levelLoader(e)}};a(A,"instance");let Ee=A;var x=(n=>(n.CLEAR="clear",n.RAIN="rain",n.SNOW="snow",n.FOG="fog",n.WIND="wind",n))(x||{});const O=class O{constructor(){a(this,"ctx",null);a(this,"weatherType","clear");a(this,"intensity",.5);a(this,"particles",[]);a(this,"isActive",!1);a(this,"lastUpdate",0);a(this,"windDirection",0);a(this,"weatherTimer",null)}static getInstance(){return O.instance||(O.instance=new O),O.instance}init(e){this.ctx=e,this.isActive=!0}setWeather(e,t=.5,i){this.weatherType=e,this.intensity=Math.max(0,Math.min(1,t)),this.particles=[],this.generateParticles(),(e==="wind"||e==="rain")&&(this.windDirection=Math.random()*Math.PI),this.weatherTimer!==null&&(window.clearTimeout(this.weatherTimer),this.weatherTimer=null),i&&(this.weatherTimer=window.setTimeout(()=>{this.setWeather("clear"),this.weatherTimer=null},i*1e3))}generateParticles(){const e=Math.floor(this.intensity*100);switch(this.weatherType){case"rain":for(let t=0;t<e;t++)this.particles.push({x:Math.random()*S,y:Math.random()*M,size:1+Math.random()*2,speed:10+Math.random()*15,opacity:.3+Math.random()*.7});break;case"snow":for(let t=0;t<e;t++)this.particles.push({x:Math.random()*S,y:Math.random()*M,size:1+Math.random()*3,speed:1+Math.random()*3,opacity:.5+Math.random()*.5});break;case"fog":for(let t=0;t<20;t++)this.particles.push({x:Math.random()*S,y:Math.random()*M,size:50+Math.random()*100,speed:.2+Math.random()*.3,opacity:.05+Math.random()*.1*this.intensity});break;case"wind":for(let t=0;t<e/2;t++)this.particles.push({x:Math.random()*S,y:Math.random()*M,size:1+Math.random()*1,speed:5+Math.random()*10,opacity:.1+Math.random()*.2,lifetime:20+Math.random()*40});break}}update(e){if(!this.isActive||this.weatherType==="clear")return;const t=performance.now();t-this.lastUpdate>100&&this.particles.length<this.intensity*100&&(this.addNewParticles(),this.lastUpdate=t),this.updateParticles(e)}addNewParticles(){if(this.weatherType==="rain")for(let e=0;e<2;e++)this.particles.push({x:Math.random()*S,y:-5,size:1+Math.random()*2,speed:10+Math.random()*15,opacity:.3+Math.random()*.7});else this.weatherType==="snow"?this.particles.push({x:Math.random()*S,y:-5,size:1+Math.random()*3,speed:1+Math.random()*3,opacity:.5+Math.random()*.5}):this.weatherType==="wind"&&Math.random()<.3&&this.particles.push({x:0,y:Math.random()*M,size:1+Math.random()*1,speed:5+Math.random()*10,opacity:.1+Math.random()*.2,lifetime:20+Math.random()*40})}updateParticles(e){const t=[];for(let i=0;i<this.particles.length;i++){const s=this.particles[i];switch(this.weatherType){case"rain":s.y+=s.speed*e,s.x+=Math.sin(this.windDirection)*s.speed*.5*e,s.y>M&&t.push(i);break;case"snow":s.y+=s.speed*e,s.x+=Math.sin(s.y*.01)*.5+Math.sin(this.windDirection)*e*2,s.y>M&&t.push(i);break;case"fog":s.x+=Math.sin(this.windDirection)*s.speed*e,s.x>S+s.size?s.x=-s.size:s.x<-s.size&&(s.x=S+s.size);break;case"wind":s.x+=s.speed*e,s.y+=Math.sin(this.windDirection+Math.PI/2)*s.speed*.2*e,s.lifetime&&(s.lifetime-=e*10,s.lifetime<=0&&t.push(i)),s.x>S&&t.push(i);break}}for(let i=t.length-1;i>=0;i--)this.particles.splice(t[i],1)}render(){if(!this.ctx||!this.isActive||this.weatherType==="clear")return;const e=this.ctx;switch(e.save(),this.weatherType){case"rain":this.renderRain(e);break;case"snow":this.renderSnow(e);break;case"fog":this.renderFog(e);break;case"wind":this.renderWind(e);break}e.restore()}renderRain(e){e.strokeStyle="#99aaff",e.lineCap="round";for(const t of this.particles)e.globalAlpha=t.opacity,e.lineWidth=t.size/2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+Math.sin(this.windDirection)*10,t.y+10),e.stroke()}renderSnow(e){e.fillStyle="#ffffff";for(const t of this.particles)e.globalAlpha=t.opacity,e.beginPath(),e.arc(t.x,t.y,t.size,0,Math.PI*2),e.fill()}renderFog(e){for(const t of this.particles){e.globalAlpha=t.opacity;const i=e.createRadialGradient(t.x,t.y,0,t.x,t.y,t.size);i.addColorStop(0,"rgba(255, 255, 255, 0.8)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.beginPath(),e.arc(t.x,t.y,t.size,0,Math.PI*2),e.fill()}}renderWind(e){e.strokeStyle="#ffffff",e.lineCap="round";for(const t of this.particles)e.globalAlpha=t.opacity,e.lineWidth=t.size/2,e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(t.x+10,t.y+Math.sin(this.windDirection+Math.PI/2)*2),e.stroke()}cleanup(){this.isActive=!1,this.particles=[],this.weatherTimer!==null&&(window.clearTimeout(this.weatherTimer),this.weatherTimer=null)}};a(O,"instance");let Be=O;const G=class G{constructor(){a(this,"achievements",new Map);a(this,"notifications",[]);a(this,"localStorageKey","mario-achievements");a(this,"listeners",[]);this.initAchievements(),this.loadSavedProgress()}static getInstance(){return G.instance||(G.instance=new G),G.instance}initAchievements(){this.registerAchievement({id:"level_1_1",title:"World 1-1",description:"Complete World 1-1",icon:"flag",unlocked:!1}),this.registerAchievement({id:"all_levels",title:"World Champion",description:"Complete all levels",icon:"trophy",unlocked:!1}),this.registerAchievement({id:"first_coin",title:"Coin Collector",description:"Collect your first coin",icon:"coin",unlocked:!1}),this.registerAchievement({id:"hundred_coins",title:"Rich Mario",description:"Collect 100 coins in total",icon:"coins",unlocked:!1,progress:0,maxProgress:100}),this.registerAchievement({id:"first_mushroom",title:"Power Up",description:"Collect your first mushroom",icon:"mushroom",unlocked:!1}),this.registerAchievement({id:"first_fire_flower",title:"Bring the Heat",description:"Collect your first fire flower",icon:"fire-flower",unlocked:!1}),this.registerAchievement({id:"first_star",title:"Invincible",description:"Collect your first star",icon:"star",unlocked:!1}),this.registerAchievement({id:"first_goomba",title:"Goomba Stomper",description:"Defeat your first Goomba",icon:"goomba",unlocked:!1}),this.registerAchievement({id:"ten_goombas",title:"Goomba Hunter",description:"Defeat 10 Goombas",icon:"goomba",unlocked:!1,progress:0,maxProgress:10}),this.registerAchievement({id:"first_koopa",title:"Shell Shocker",description:"Defeat your first Koopa",icon:"koopa",unlocked:!1}),this.registerAchievement({id:"speedrun",title:"Speed Demon",description:"Complete a level in under 100 seconds",icon:"clock",unlocked:!1,secret:!0}),this.registerAchievement({id:"no_damage",title:"Untouchable",description:"Complete a level without taking damage",icon:"shield",unlocked:!1,secret:!0}),this.registerAchievement({id:"all_coins",title:"Treasure Hunter",description:"Collect all coins in a level",icon:"chest",unlocked:!1,secret:!0})}registerAchievement(e){this.achievements.set(e.id,e)}getAllAchievements(e=!0){return Array.from(this.achievements.values()).filter(t=>e||!t.secret||t.unlocked)}getAchievement(e){return this.achievements.get(e)}isUnlocked(e){const t=this.achievements.get(e);return t?t.unlocked:!1}unlockAchievement(e){const t=this.achievements.get(e);return t&&!t.unlocked?(t.unlocked=!0,t.unlockedAt=Date.now(),this.notifications.push({achievement:t,timestamp:Date.now(),displayed:!1}),this.notifyListeners(t),this.saveProgress(),!0):!1}updateProgress(e,t){const i=this.achievements.get(e);if(i&&!i.unlocked&&i.maxProgress!==void 0){if(i.progress=Math.min(t,i.maxProgress),i.progress>=i.maxProgress)return this.unlockAchievement(e);this.saveProgress()}return!1}incrementProgress(e,t=1){const i=this.achievements.get(e);if(i&&!i.unlocked&&i.progress!==void 0){const s=(i.progress||0)+t;return this.updateProgress(e,s)}return!1}getPendingNotifications(){return this.notifications.filter(e=>!e.displayed)}markNotificationsAsDisplayed(e){for(const t of e)t.displayed=!0}addListener(e){this.listeners.push(e)}removeListener(e){const t=this.listeners.indexOf(e);t!==-1&&this.listeners.splice(t,1)}notifyListeners(e){for(const t of this.listeners)try{t(e)}catch(i){console.error("Error in achievement listener:",i)}}saveProgress(){try{const e=Array.from(this.achievements.values()).map(t=>({id:t.id,unlocked:t.unlocked,progress:t.progress,unlockedAt:t.unlockedAt}));localStorage.setItem(this.localStorageKey,JSON.stringify(e))}catch(e){console.error("Failed to save achievement progress:",e)}}loadSavedProgress(){try{const e=localStorage.getItem(this.localStorageKey);if(e){const t=JSON.parse(e);for(const i of t){const s=this.achievements.get(i.id);s&&(s.unlocked=i.unlocked,i.progress!==void 0&&(s.progress=i.progress),i.unlockedAt&&(s.unlockedAt=i.unlockedAt))}}}catch(e){console.error("Failed to load achievement progress:",e)}}resetAchievements(){for(const e of this.achievements.values())e.unlocked=!1,e.progress!==void 0&&(e.progress=0),e.unlockedAt=void 0;this.notifications=[],this.saveProgress()}};a(G,"instance");let Oe=G;const j=class j{constructor(){a(this,"currentDifficulty",2);a(this,"metrics",{deathCount:0,timeTaken:[],enemiesDefeated:0,powerupsCollected:0,jumps:0,fallsIntoGaps:0,levelCompletions:0,livesLost:0,timeSpentAsSmallMario:0,lastUpdated:Date.now()});a(this,"autoAdjust",!0);a(this,"difficultyChangeThreshold",3);a(this,"localStorageKey","mario-difficulty");a(this,"defaultDifficulty",2);a(this,"defaultParams",new Map);a(this,"difficultyParams");this.initDefaultParams(),this.loadSettings(),this.difficultyParams=this.getParamsForDifficulty(this.currentDifficulty)}static getInstance(){return j.instance||(j.instance=new j),j.instance}initDefaultParams(){this.defaultParams.set(0,{enemySpeed:.6,enemySpawnRate:.6,powerupFrequency:1.5,playerJumpHeight:1.2,timeLimit:1.5,gapWidth:.7,assistMode:!0}),this.defaultParams.set(1,{enemySpeed:.8,enemySpawnRate:.8,powerupFrequency:1.2,playerJumpHeight:1.1,timeLimit:1.3,gapWidth:.8,assistMode:!1}),this.defaultParams.set(2,{enemySpeed:1,enemySpawnRate:1,powerupFrequency:1,playerJumpHeight:1,timeLimit:1,gapWidth:1,assistMode:!1}),this.defaultParams.set(3,{enemySpeed:1.2,enemySpawnRate:1.2,powerupFrequency:.8,playerJumpHeight:1,timeLimit:.9,gapWidth:1.1,assistMode:!1}),this.defaultParams.set(4,{enemySpeed:1.4,enemySpawnRate:1.5,powerupFrequency:.6,playerJumpHeight:1,timeLimit:.8,gapWidth:1.2,assistMode:!1})}loadSettings(){try{const e=localStorage.getItem(this.localStorageKey);if(e){const t=JSON.parse(e);this.currentDifficulty=t.difficulty??this.defaultDifficulty,this.autoAdjust=t.autoAdjust??!0}}catch(e){console.warn("Failed to load difficulty settings",e),this.currentDifficulty=this.defaultDifficulty}}saveSettings(){try{const e={difficulty:this.currentDifficulty,autoAdjust:this.autoAdjust};localStorage.setItem(this.localStorageKey,JSON.stringify(e))}catch(e){console.warn("Failed to save difficulty settings",e)}}getParamsForDifficulty(e){return this.defaultParams.get(e)??this.defaultParams.get(2)}getDifficultyLevel(){return this.currentDifficulty}getDifficultyParams(){return{...this.difficultyParams}}setDifficultyLevel(e){this.currentDifficulty=e,this.difficultyParams=this.getParamsForDifficulty(e),this.saveSettings()}setAutoAdjust(e){this.autoAdjust=e,this.saveSettings()}isAutoAdjustEnabled(){return this.autoAdjust}registerDeath(){this.metrics.deathCount++,this.metrics.livesLost++,this.metrics.lastUpdated=Date.now(),this.autoAdjust&&this.metrics.deathCount>=this.difficultyChangeThreshold&&this.adjustDifficultyBasedOnPerformance()}registerLevelCompletion(e){this.metrics.levelCompletions++,this.metrics.timeTaken.push(e),this.metrics.timeTaken.length>5&&this.metrics.timeTaken.shift(),this.metrics.lastUpdated=Date.now(),this.autoAdjust&&this.considerDifficultyIncrease()}registerEnemyDefeated(){this.metrics.enemiesDefeated++,this.metrics.lastUpdated=Date.now()}registerPowerupCollected(){this.metrics.powerupsCollected++,this.metrics.lastUpdated=Date.now()}registerJump(){this.metrics.jumps++,this.metrics.lastUpdated=Date.now()}registerFallIntoGap(){this.metrics.fallsIntoGaps++,this.metrics.lastUpdated=Date.now(),this.autoAdjust&&this.metrics.fallsIntoGaps>=this.difficultyChangeThreshold&&this.considerDifficultyDecrease()}registerSmallMarioTime(e){this.metrics.timeSpentAsSmallMario+=e,this.metrics.lastUpdated=Date.now()}considerDifficultyDecrease(){this.currentDifficulty>0&&(this.setDifficultyLevel(this.currentDifficulty-1),this.resetMetrics(),this.notifyDifficultyChange(!1))}considerDifficultyIncrease(){this.metrics.levelCompletions>=2&&this.metrics.deathCount<2&&this.currentDifficulty<4&&(this.setDifficultyLevel(this.currentDifficulty+1),this.resetMetrics(),this.notifyDifficultyChange(!0))}adjustDifficultyBasedOnPerformance(){const e=this.calculatePerformanceScore();e<-10?this.considerDifficultyDecrease():e>10&&this.metrics.levelCompletions>0&&this.considerDifficultyIncrease(),this.resetMetrics()}calculatePerformanceScore(){let e=0;return e-=this.metrics.deathCount*5,e-=this.metrics.fallsIntoGaps*3,e+=this.metrics.levelCompletions*8,e+=Math.min(this.metrics.enemiesDefeated,10),e+=Math.min(this.metrics.powerupsCollected,5),this.metrics.timeSpentAsSmallMario>60&&(e-=3),e}resetMetrics(){this.metrics={deathCount:0,timeTaken:this.metrics.timeTaken,enemiesDefeated:0,powerupsCollected:0,jumps:0,fallsIntoGaps:0,levelCompletions:0,livesLost:0,timeSpentAsSmallMario:0,lastUpdated:Date.now()}}notifyDifficultyChange(e){const t=["Very Easy","Easy","Normal","Hard","Very Hard"];b.debugEnabled&&console.log(`Difficulty ${e?"increased":"decreased"} to ${t[this.currentDifficulty]}`)}resetToDefaults(){this.currentDifficulty=this.defaultDifficulty,this.autoAdjust=!0,this.difficultyParams=this.getParamsForDifficulty(this.currentDifficulty),this.resetMetrics(),this.saveSettings()}};a(j,"instance");let Ge=j;const $=class ${constructor(){a(this,"ctx",null);a(this,"isShaking",!1);a(this,"shakeOptions",null);a(this,"startTime",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"originalTransform",null);a(this,"enabled",!0);a(this,"intensityMultiplier",1)}static getInstance(){return $.instance||($.instance=new $),$.instance}init(e,t){this.ctx=t,this.loadSettings()}loadSettings(){try{const e=localStorage.getItem("mario-screen-shake");if(e){const t=JSON.parse(e);this.enabled=t.enabled??!0,this.intensityMultiplier=t.intensityMultiplier??1}}catch(e){console.warn("Failed to load screen shake settings",e)}}saveSettings(){try{const e={enabled:this.enabled,intensityMultiplier:this.intensityMultiplier};localStorage.setItem("mario-screen-shake",JSON.stringify(e))}catch(e){console.warn("Failed to save screen shake settings",e)}}setEnabled(e){this.enabled=e,this.saveSettings(),!e&&this.isShaking&&this.stopShaking()}isEnabled(){return this.enabled}setIntensityMultiplier(e){this.intensityMultiplier=Math.max(0,Math.min(2,e)),this.saveSettings()}getIntensityMultiplier(){return this.intensityMultiplier}shake(e){!this.enabled||!this.ctx||(this.stopShaking(),this.originalTransform=this.ctx.getTransform(),this.shakeOptions={...e,intensity:e.intensity*this.intensityMultiplier,frequency:e.frequency||8},this.isShaking=!0,this.startTime=performance.now())}stopShaking(){this.isShaking&&this.ctx&&this.originalTransform&&(this.ctx.setTransform(this.originalTransform),this.isShaking=!1,this.shakeOptions=null,this.offsetX=0,this.offsetY=0,this.originalTransform=null)}update(){if(!this.isShaking||!this.shakeOptions||!this.ctx||!this.originalTransform)return;const t=performance.now()-this.startTime;if(t>=this.shakeOptions.duration){this.stopShaking();return}const i=t/this.shakeOptions.duration;let s=this.shakeOptions.intensity;this.shakeOptions.decay&&(s*=1-i),this.calculateShakeOffset(s,t,this.shakeOptions.pattern),this.ctx.setTransform(this.originalTransform),this.ctx.translate(this.offsetX,this.offsetY)}calculateShakeOffset(e,t,i){var h;const s=e*10,r=((h=this.shakeOptions)==null?void 0:h.frequency)||8,o=t/1e3*r*Math.PI*2;let l=0,c=0,d=0,u=0;switch(i){case 0:this.offsetX=Math.sin(o)*s,this.offsetY=0;break;case 1:this.offsetX=0,this.offsetY=Math.sin(o)*s;break;case 2:l=o*2,this.offsetX=Math.sin(l)*s*Math.sin(l*.5),this.offsetY=Math.cos(l)*s*Math.sin(l*.5);break;case 3:c=Math.sin(Math.min(Math.PI,t/1e3*15)),d=c*s,u=t/1e3*4,this.offsetX=Math.sin(u)*d,this.offsetY=Math.cos(u)*d;break;case 4:this.offsetX=(Math.random()*2-1)*s*.3,this.offsetY=(Math.random()*2-1)*s*.3;break}}smallImpact(){this.shake({pattern:1,intensity:.2,duration:200,decay:!0,frequency:12})}mediumImpact(){this.shake({pattern:2,intensity:.4,duration:300,decay:!0,frequency:10})}largeImpact(){this.shake({pattern:3,intensity:.7,duration:500,decay:!0,frequency:8})}groundPound(){this.shake({pattern:1,intensity:.6,duration:400,decay:!0,frequency:9})}playerDeath(){this.shake({pattern:2,intensity:.5,duration:700,decay:!1,frequency:6})}rumble(e=2e3){this.shake({pattern:4,intensity:.3,duration:e,decay:!1,frequency:20})}cleanup(){this.stopShaking()}};a($,"instance");let je=$;class qi{constructor(){a(this,"container");a(this,"notifications",[]);a(this,"maxNotifications",3);a(this,"animationDuration",300);a(this,"displayDuration",5e3);a(this,"iconBasePath","/img/icons/");this.container=document.createElement("div"),this.container.className="achievement-notifications",this.container.style.position="absolute",this.container.style.top="20px",this.container.style.right="20px",this.container.style.zIndex="1000",this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.gap="10px",this.container.style.pointerEvents="none",document.body.appendChild(this.container)}show(e){const{achievement:t}=e,i=document.createElement("div");i.className="achievement-notification",i.style.backgroundColor="rgba(0, 0, 0, 0.8)",i.style.color="white",i.style.borderRadius="5px",i.style.padding="10px",i.style.display="flex",i.style.alignItems="center",i.style.maxWidth="300px",i.style.transform="translateX(100%)",i.style.opacity="0",i.style.transition=`transform ${this.animationDuration}ms ease-out, opacity ${this.animationDuration}ms ease-out`,i.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",i.style.border="1px solid rgba(255, 255, 255, 0.2)";const s=document.createElement("div");s.style.marginRight="10px",s.style.width="32px",s.style.height="32px",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center";try{const d=document.createElement("img");d.src=`${this.iconBasePath}${t.icon}.png`,d.alt=t.title,d.style.width="100%",d.style.height="100%",d.style.objectFit="contain",d.onerror=()=>{s.textContent="🏆",s.style.fontSize="24px"},s.appendChild(d)}catch{s.textContent="🏆",s.style.fontSize="24px"}i.appendChild(s);const r=document.createElement("div");r.style.flex="1";const o=document.createElement("div");o.textContent=t.title,o.style.fontWeight="bold",o.style.fontSize="14px",o.style.marginBottom="3px",r.appendChild(o);const l=document.createElement("div");l.textContent=t.description,l.style.fontSize="12px",l.style.opacity="0.8",r.appendChild(l),i.appendChild(r);const c=document.createElement("div");c.textContent="×",c.style.fontSize="16px",c.style.marginLeft="10px",c.style.cursor="pointer",c.style.pointerEvents="auto",c.style.opacity="0.6",c.style.transition="opacity 200ms",c.style.width="20px",c.style.height="20px",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.borderRadius="50%",c.addEventListener("mouseover",()=>{c.style.opacity="1"}),c.addEventListener("mouseout",()=>{c.style.opacity="0.6"}),c.addEventListener("click",()=>{this.dismiss(i)}),i.appendChild(c),this.container.appendChild(i),this.notifications.push(i),setTimeout(()=>{i.style.transform="translateX(0)",i.style.opacity="1"},10),setTimeout(()=>{i.parentNode===this.container&&this.dismiss(i)},this.displayDuration),this.pruneNotifications()}dismiss(e){e.style.transform="translateX(100%)",e.style.opacity="0",setTimeout(()=>{e.parentNode===this.container&&this.container.removeChild(e);const t=this.notifications.indexOf(e);t!==-1&&this.notifications.splice(t,1)},this.animationDuration)}pruneNotifications(){for(;this.notifications.length>this.maxNotifications;){const e=this.notifications[0];this.dismiss(e)}}showBatch(e,t=800){if(e.length===0)return;let i=0;const s=()=>{i<e.length&&(this.show(e[i]),i++,setTimeout(s,t))};s()}clearAll(){for(const e of[...this.notifications])this.dismiss(e)}}class Ki{constructor(e){a(this,"canvas");a(this,"gameService");a(this,"inputService");a(this,"debugService");a(this,"saveService");a(this,"weatherService");a(this,"achievementService");a(this,"difficultyService");a(this,"screenShakeService");a(this,"achievementUI");a(this,"sceneRunner");a(this,"timer");a(this,"mario");a(this,"currentLevel");a(this,"_isPaused");a(this,"pauseMenu");a(this,"gameUI");a(this,"debugPanel");a(this,"_weatherInterval",null);this.canvas=e,this.gameService=De.getInstance(),this.inputService=Re.getInstance(),this.debugService=Fe.getInstance(),this.saveService=Ne.getInstance(),this.weatherService=Be.getInstance(),this.achievementService=Oe.getInstance(),this.difficultyService=Ge.getInstance(),this.screenShakeService=je.getInstance(),this.achievementUI=new qi,this.sceneRunner=new $i,this.timer=new ut(1/60),this.mario=null,this.currentLevel=null,this._isPaused=!1,this.pauseMenu=null,this.gameUI=null,this.debugPanel=null}async init(){this.canvas.width=S,this.canvas.height=M,this.createGameUI();const e=this.createLoadingIndicator();document.body.appendChild(e);const t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get canvas context");this.gameService.init(t),this.inputService.init(window),this.debugService.init(),this.weatherService.init(t),this.screenShakeService.init(this.canvas,t),this.inputService.setPauseHandler(()=>{this._isPaused?this.resume():this.pause()}),this.setupDebugPanel(),this.checkPendingAchievements();try{try{const l=ze.getInstance();await l.preloadEssentialAssets(),l.preloadAllInBackground(c=>{this.updateLoadingProgress(e,c)})}catch(l){console.warn("Asset preloading error, continuing anyway:",l)}const[i,s]=await Promise.all([Bi(this.gameService.audioContext),ri()]);this.gameService.setEntityFactory(i),this.gameService.setFont(s),await Ee.getInstance().initLevelLoader(i);const o=await we(i);this.mario=i.mario(),zt(this.mario,"MARIO"),window.mario=this.mario,this.inputService.addReceiver(this.mario),this.timer.update=l=>{if(this.screenShakeService.update(),this.applyDifficultySettings(),this.gameService.update(l),this.sceneRunner.update(this.gameService.getGameContext()),this.weatherService.update(l),this.mario){this.debugService.set("FPS",Math.round(1/l)),this.debugService.set("Position",`X: ${Math.round(this.mario.pos.x)}, Y: ${Math.round(this.mario.pos.y)}`),this.debugService.set("Velocity",`X: ${this.mario.vel.x.toFixed(2)}, Y: ${this.mario.vel.y.toFixed(2)}`);const c=this.mario.traits.get(Function("return function Go(){}").constructor);c&&this.debugService.set("Speed",c.distance.toFixed(2))}this.updateDebugPanel()},this.setupAchievementListeners(),await this.startWorld("1-1",o),e&&e.parentNode&&e.remove(),this.clearAllLoadingIndicators(),this.timer.start(),this.addRandomWeather()}catch(i){console.error("Error initializing game:",i);const s=document.createElement("div");s.className="error-message",s.textContent="Failed to load game resources. Please refresh and try again.",document.body.appendChild(s),e&&e.parentNode&&e.remove()}}createGameUI(){this.gameUI=document.createElement("div"),this.gameUI.id="game-ui",document.body.appendChild(this.gameUI),this.debugPanel=document.createElement("div"),this.debugPanel.id="debug-panel",document.body.appendChild(this.debugPanel);const e=document.createElement("button");e.id="settings-button",e.textContent="⚙️",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.6)",e.style.color="white",e.style.border="none",e.style.borderRadius="5px",e.style.padding="5px 10px",e.style.fontSize="20px",e.style.cursor="pointer",e.style.zIndex="100",e.title="Settings",e.addEventListener("click",()=>{this.showSettingsMenu()}),document.body.appendChild(e)}updateDebugPanel(){if(this.debugPanel)if(this.debugService.isEnabled()){document.body.classList.add("debug-active");const e=this.debugService.getAll();let t="";for(const[i,s]of Object.entries(e))t+=`<div><strong>${i}:</strong> ${s}</div>`;this.debugPanel.innerHTML=t}else document.body.classList.remove("debug-active")}setupDebugPanel(){this.updateDebugPanel()}createPauseMenu(){if(this.pauseMenu){this.pauseMenu.style.display="block";return}this.pauseMenu=document.createElement("div"),this.pauseMenu.className="menu";const e=document.createElement("div");e.className="menu-title",e.textContent="Paused",this.pauseMenu.appendChild(e);const t=document.createElement("button");t.className="menu-button",t.textContent="Resume",t.addEventListener("click",()=>this.resume()),this.pauseMenu.appendChild(t);const i=document.createElement("button");i.className="menu-button",i.textContent="Restart Level",i.addEventListener("click",()=>{this.restartLevel(),this.resume()}),this.pauseMenu.appendChild(i);const s=document.createElement("button");s.className="menu-button",s.textContent="Save Game",s.addEventListener("click",()=>{this.saveGame()}),this.pauseMenu.appendChild(s);const r=document.createElement("button");r.className="menu-button",r.textContent="Load Game",r.disabled=!this.hasSave(),r.addEventListener("click",()=>{this.loadSavedGame(),this.resume()}),this.pauseMenu.appendChild(r);const o=document.createElement("button");o.className="menu-button",o.textContent=this.gameService.isSoundEnabled()?"Sound: ON":"Sound: OFF",o.addEventListener("click",()=>{this.toggleSound(),o.textContent=this.gameService.isSoundEnabled()?"Sound: ON":"Sound: OFF"}),this.pauseMenu.appendChild(o);const l=document.createElement("button");l.className="menu-button",l.textContent=this.gameService.isMusicEnabled()?"Music: ON":"Music: OFF",l.addEventListener("click",()=>{this.toggleMusic(),l.textContent=this.gameService.isMusicEnabled()?"Music: ON":"Music: OFF"}),this.pauseMenu.appendChild(l);const c=document.createElement("button");c.className="menu-button",c.textContent=this.debugService.isEnabled()?"Debug: ON":"Debug: OFF",c.addEventListener("click",()=>{this.toggleDebug(),c.textContent=this.debugService.isEnabled()?"Debug: ON":"Debug: OFF"}),this.pauseMenu.appendChild(c),this.gameUI?this.gameUI.appendChild(this.pauseMenu):document.body.appendChild(this.pauseMenu)}hidePauseMenu(){this.pauseMenu&&(this.pauseMenu.style.display="none")}restartLevel(){this.currentLevel&&this.mario&&_e(this.mario,this.currentLevel.name)}createLoadingScreen(e){const t=this.gameService.font,i=new ee;i.comp.layers.push(Ye("#000")),t&&i.comp.layers.push(Oi(t,`Loading ${e}...`));const s=document.createElement("div");return s.className="loading",s.textContent=`Loading ${e}`,this.gameUI?this.gameUI.appendChild(s):document.body.appendChild(s),i.events.listen(ee.EVENT_COMPLETE,()=>{s.remove()}),i}async setupLevel(e,t){const i=this.createLoadingScreen(e);this.sceneRunner.addScene(i),this.sceneRunner.runNext();const s=await t(e);this.currentLevel=s,Bt(this.mario,s),i.complete(),s.events.listen(he.TRIGGER,(o,l,c)=>{if(o.type==="goto"&&ye(c).next().done===!1){this.startWorld(o.name,t);return}}),s.events.listen(me.EVENT_PIPE_COMPLETE,async o=>{if(o.props.goesTo){const l=await this.setupLevel(o.props.goesTo.name,t);this.sceneRunner.addScene(l),this.sceneRunner.runNext(),o.props.backTo&&(console.log(o.props),l.events.listen(he.COMPLETE,async()=>{const c=await this.setupLevel(e,t),d=c.entities.get(o.props.backTo);d&&(ki(d,this.mario),this.sceneRunner.addScene(c),this.sceneRunner.runNext())}))}else s.events.emit(he.COMPLETE)});const r=this.gameService.font;if(r){const o=Qe(r,this.mario);s.comp.layers.push(o)}return s}clearAllLoadingIndicators(){document.querySelectorAll(".loading").forEach(t=>{t.remove()})}async startWorld(e,t){const i=await this.setupLevel(e,t);_e(this.mario,e),this.clearAllLoadingIndicators();const s=this.gameService.font;if(s){const r=ji(s,i),o=Qe(s,this.mario),l=new Ji;l.countDown=0,l.comp.layers.push(Ye("#000")),l.comp.layers.push(o),l.comp.layers.push(r),this.sceneRunner.addScene(l)}this.sceneRunner.addScene(i),this.sceneRunner.runNext()}pause(){this._isPaused||(this._isPaused=!0,this.timer.stop(),this.gameService.pause(),this.createPauseMenu())}resume(){this._isPaused&&(this._isPaused=!1,this.timer.start(),this.gameService.resume(),this.hidePauseMenu())}get isPaused(){return this._isPaused}toggleMusic(){this.gameService.toggleMusic()}toggleSound(){this.gameService.toggleSound()}toggleDebug(){this.debugService.toggle()}saveGame(){if(!this.mario||!this.currentLevel)return;const e=this.saveService.createSaveState(this.mario,this.currentLevel);this.saveService.saveGame(e);const t=document.createElement("div");t.textContent="Game saved!",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.padding="10px 20px",t.style.borderRadius="5px",t.style.fontFamily="sans-serif",t.style.zIndex="1000",document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},2e3)}async loadGame(e){const t=this.saveService.loadGame();return t?(await this.startWorld(t.levelName,e),this.mario&&t.position&&this.mario.pos.set(t.position.x,t.position.y),!0):!1}hasSave(){return this.saveService.hasSave()}async loadSavedGame(){const e=this.gameService.entityFactory;if(!e){console.error("Entity factory not initialized");return}try{const t=await we(e),i=await this.loadGame(t);console.log(i?"Game loaded successfully":"No saved game found")}catch(t){console.error("Error loading saved game:",t)}}createLoadingIndicator(){const e=document.createElement("div");e.className="loading";const t=document.createElement("div");t.textContent="Loading...",e.appendChild(t);const i=document.createElement("div");i.className="progress-container",e.appendChild(i);const s=document.createElement("div");s.className="progress-bar",s.style.width="10%",i.appendChild(s);const r=document.createElement("div");return r.className="progress-text",r.textContent="Preparing game...",e.appendChild(r),e}updateLoadingProgress(e,t){if(e)try{const i=e.querySelector(".progress-bar"),s=e.querySelector(".progress-text");i instanceof HTMLElement&&(i.style.width=`${Math.max(10,t.percentage)}%`),s&&(t.percentage>=100?s.textContent="Ready!":t.percentage>0&&(s.textContent=`${t.percentage}%`))}catch(i){console.warn("Error updating progress:",i)}}cleanup(){this.timer.stop(),this.inputService&&this.inputService.removeReceiver(this.mario),this.weatherService&&this.weatherService.cleanup(),this.screenShakeService&&this.screenShakeService.cleanup(),this.gameUI&&this.gameUI.parentNode&&this.gameUI.remove(),this.debugPanel&&this.debugPanel.parentNode&&this.debugPanel.remove(),this.pauseMenu&&this.pauseMenu.parentNode&&this.pauseMenu.remove();const e=document.getElementById("settings-button");e&&e.parentNode&&e.remove();const t=document.getElementById("settings-menu");t&&t.parentNode&&t.remove();const i=document.querySelector(".achievement-notifications");i&&i.parentNode&&i.remove(),this._weatherInterval&&(clearInterval(this._weatherInterval),this._weatherInterval=null),this.mario=null,this.currentLevel=null,window.mario=null}async loadLevel(e){try{const t=this.gameService.entityFactory;if(!t)throw new Error("Entity factory not initialized");const i=await we(t),s=await Ee.getLevel(e,i);return this.clearAllLoadingIndicators(),s}catch(t){throw console.error("Failed to load level:",t),this.clearAllLoadingIndicators(),t}}applyDifficultySettings(){if(!this.mario||!this.currentLevel)return;const e=this.difficultyService.getDifficultyParams(),t=this.mario.traits.get(Function("return function Jump(){}").constructor);t&&e.playerJumpHeight!==1&&(t.difficultyApplied||(t.velocity=vt*e.playerJumpHeight,t.difficultyApplied=!0))}setupAchievementListeners(){this.achievementService.addListener(e=>{this.achievementUI.show({achievement:e,timestamp:Date.now(),displayed:!1}),(e.id==="all_levels"||e.id==="no_damage")&&(this.pause(),setTimeout(()=>this.resume(),2e3))})}checkPendingAchievements(){const e=this.achievementService.getPendingNotifications();e.length>0&&(this.achievementUI.showBatch(e),this.achievementService.markNotificationsAsDisplayed(e))}addRandomWeather(){const e=[x.CLEAR,x.RAIN,x.SNOW,x.FOG,x.WIND];this.weatherService.setWeather(x.CLEAR),this._weatherInterval=setInterval(()=>{if(this._isPaused)return;const t=e[Math.floor(Math.random()*e.length)],i=.3+Math.random()*.7,s=2e4+Math.random()*3e4;this.weatherService.setWeather(t,i,s/1e3)},5e4)}registerPlayerDeath(){this.difficultyService.registerDeath(),this.screenShakeService.playerDeath()}registerLevelCompletion(e,t){this.difficultyService.registerLevelCompletion(t),e==="1-1"&&this.achievementService.unlockAchievement("level_1_1"),t<100&&this.achievementService.unlockAchievement("speedrun")}showSettingsMenu(){if(document.getElementById("settings-menu"))return;const e=!this._isPaused;e&&this.pause();const t=document.createElement("div");t.id="settings-menu",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.85)",t.style.padding="20px",t.style.color="white",t.style.borderRadius="5px",t.style.zIndex="1000",t.style.minWidth="300px";const i=document.createElement("h2");i.textContent="Settings",i.style.textAlign="center",i.style.marginTop="0",t.appendChild(i);const s=document.createElement("div");s.style.marginBottom="20px";const r=document.createElement("h3");r.textContent="Weather Effects",r.style.marginBottom="10px",s.appendChild(r);const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.marginBottom="10px";const l=document.createElement("label");l.textContent="Current Weather:",o.appendChild(l);const c=document.createElement("select");[{value:"clear",label:"Clear"},{value:"rain",label:"Rain"},{value:"snow",label:"Snow"},{value:"fog",label:"Fog"},{value:"wind",label:"Wind"}].forEach(E=>{const C=document.createElement("option");C.value=E.value,C.textContent=E.label,c.appendChild(C)}),c.addEventListener("change",()=>{switch(c.value){case"clear":this.weatherService.setWeather(x.CLEAR,.7);break;case"rain":this.weatherService.setWeather(x.RAIN,.7);break;case"snow":this.weatherService.setWeather(x.SNOW,.7);break;case"fog":this.weatherService.setWeather(x.FOG,.7);break;case"wind":this.weatherService.setWeather(x.WIND,.7);break}}),o.appendChild(c),s.appendChild(o),t.appendChild(s);const u=document.createElement("div");u.style.marginBottom="20px";const h=document.createElement("h3");h.textContent="Difficulty",h.style.marginBottom="10px",u.appendChild(h);const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="space-between",p.style.marginBottom="10px";const L=document.createElement("label");L.textContent="Game Difficulty:",p.appendChild(L);const te=document.createElement("select");[{value:0,label:"Very Easy"},{value:1,label:"Easy"},{value:2,label:"Normal"},{value:3,label:"Hard"},{value:4,label:"Very Hard"}].forEach(E=>{const C=document.createElement("option");C.value=E.value.toString(),C.textContent=E.label,te.appendChild(C)}),te.value=this.difficultyService.getDifficultyLevel().toString(),te.addEventListener("change",()=>{const E=parseInt(te.value,10);if(this.difficultyService.setDifficultyLevel(E),this.mario){const C=this.mario.traits.get(Function("return function Jump(){}").constructor);C&&(C.difficultyApplied=!1)}}),p.appendChild(te),u.appendChild(p);const H=document.createElement("div");H.style.display="flex",H.style.justifyContent="space-between",H.style.alignItems="center";const Ve=document.createElement("label");Ve.textContent="Dynamic Difficulty:",H.appendChild(Ve);const ie=document.createElement("input");ie.type="checkbox",ie.checked=this.difficultyService.isAutoAdjustEnabled(),ie.addEventListener("change",()=>{this.difficultyService.setAutoAdjust(ie.checked)}),H.appendChild(ie),u.appendChild(H),t.appendChild(u);const q=document.createElement("div");q.style.marginBottom="20px";const Pe=document.createElement("h3");Pe.textContent="Screen Effects",Pe.style.marginBottom="10px",q.appendChild(Pe);const D=document.createElement("div");D.style.display="flex",D.style.justifyContent="space-between",D.style.alignItems="center",D.style.marginBottom="10px";const He=document.createElement("label");He.textContent="Screen Shake:",D.appendChild(He);const se=document.createElement("input");se.type="checkbox",se.checked=this.screenShakeService.isEnabled(),se.addEventListener("change",()=>{this.screenShakeService.setEnabled(se.checked)}),D.appendChild(se),q.appendChild(D),t.appendChild(q);const ne=document.createElement("div");ne.style.marginBottom="10px";const be=document.createElement("label");be.textContent="Effect Intensity:",be.style.display="block",be.style.marginBottom="5px",ne.appendChild(be);const re=document.createElement("div");re.style.display="flex",re.style.alignItems="center";const k=document.createElement("input");k.type="range",k.min="0",k.max="2",k.step="0.1",k.value=this.screenShakeService.getIntensityMultiplier().toString(),k.style.flex="1";const K=document.createElement("span");K.textContent=k.value,K.style.marginLeft="10px",K.style.width="30px",K.style.textAlign="center",k.addEventListener("input",()=>{const E=parseFloat(k.value);this.screenShakeService.setIntensityMultiplier(E),K.textContent=E.toFixed(1)}),re.appendChild(k),re.appendChild(K),ne.appendChild(re);const U=document.createElement("button");U.textContent="Test Effect",U.style.marginTop="5px",U.style.padding="5px 10px",U.style.width="100%",U.addEventListener("click",()=>{this.screenShakeService.mediumImpact()}),ne.appendChild(U),q.appendChild(ne),t.appendChild(q);const _=document.createElement("button");_.textContent="Close",_.style.padding="10px",_.style.width="100%",_.style.marginTop="10px",_.addEventListener("click",()=>{t.remove(),e&&this.resume()}),t.appendChild(_),document.body.appendChild(t)}}let ue=null,fe=null;const Ui=async n=>{try{fe=new Ki(n),await fe.init(),_i(fe),Wi()}catch(e){console.error("Error initializing game:",e),ct("Failed to initialize the game. Please try again.")}},_i=n=>{ue=e=>{e.key==="Escape"&&(n.isPaused?n.resume():n.pause()),e.key==="m"&&n.toggleMusic(),e.key==="s"&&n.toggleSound(),e.key==="d"&&n.toggleDebug(),e.key==="F5"&&(e.preventDefault(),n.saveGame()),e.key==="F9"&&(e.preventDefault(),n.loadSavedGame())},window.addEventListener("keydown",ue)},Wi=()=>{window.addEventListener("beforeunload",()=>{ue&&(window.removeEventListener("keydown",ue),ue=null),fe&&fe.cleanup()})},ct=n=>{const e=document.createElement("div");e.className="error-message",e.textContent=n,document.body.appendChild(e),setTimeout(()=>{e.classList.add("fade-out"),setTimeout(()=>e.remove(),1e3)},5e3)},Xi=()=>{const n=document.createElement("div");n.className="menu",n.style.textAlign="center";const e=document.createElement("h1");e.textContent="Super Mario",e.style.fontFamily="Arial, sans-serif",e.style.color="white",e.style.fontSize="28px",e.style.marginBottom="20px",n.appendChild(e);const t=document.createElement("img");t.src="/img/mario-start.png",t.alt="Super Mario",t.style.width="200px",t.style.marginBottom="20px",t.onerror=()=>{t.style.display="none"},n.appendChild(t);const i=document.createElement("button");i.className="menu-button",i.textContent="Start Game",i.style.fontSize="18px",i.style.padding="10px 30px",i.style.margin="10px auto",i.style.display="block",n.appendChild(i);const s=document.createElement("div");s.style.marginTop="20px",s.style.fontSize="14px",s.style.color="#ddd",s.innerHTML=`
    <p>Controls:</p>
    <p>Arrows/WASD: Move</p>
    <p>Space/Up: Jump</p>
    <p>Shift/Down: Run</p>
    <p>Escape: Pause</p>
  `,n.appendChild(s);const r=document.createElement("div");return r.style.marginTop="20px",r.style.fontSize="12px",r.style.color="#999",r.textContent="Super Mario Clone",n.appendChild(r),document.body.appendChild(n),{startScreen:n,startButton:i}},Yi=()=>{const n=document.getElementById("screen");if(!n){ct("Canvas element not found!");return}const{startScreen:e,startButton:t}=Xi();t.addEventListener("click",()=>{e.remove(),Ui(n)})};Yi();
